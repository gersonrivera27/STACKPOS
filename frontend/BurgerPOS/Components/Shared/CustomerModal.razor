@using BurgerPOS.Services
@using BurgerPOS.Models
@using System.Text.Json
@inject PosApiService ApiService
@inject IJSRuntime JS
@inject ILogger<CustomerModal> Logger
@implements IDisposable
@rendermode InteractiveServer

<link rel="stylesheet" href="css/components/customer-modal.css" />

@if (IsOpen)
{
    <div class="modal-backdrop" @onclick="HandleBackdropClick">
        <div class="modal-customer" @onclick:stopPropagation="true" @ref="modalElement">
            <div class="modal-header">
                <h2>@(IsEditMode ? "Editar Cliente" : "Nuevo Cliente")</h2>
                <button class="btn-close" @onclick="Cancel" type="button">√ó</button>
            </div>

            <div class="modal-body">
                @if (isSearching)
                {
                    <div class="loading-indicator">
                        <div class="spinner-small"></div>
                        <span>Buscando cliente...</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-error">
                        <strong>Error:</strong> @errorMessage
                    </div>
                }

                @if (existingCustomer != null && !IsEditMode)
                {
                    <div class="alert alert-info">
                        <strong>Cliente encontrado:</strong> @existingCustomer.Name
                        <button class="btn-link" @onclick="UseExistingCustomer" type="button">
                            Usar este cliente
                        </button>
                        <button class="btn-link" @onclick="CreateNew" type="button">
                            Crear nuevo
                        </button>
                    </div>
                }

                <form class="customer-form">
                    <!-- Tel√©fono -->
                    <div class="form-group">
                        <label class="form-label required">Tel√©fono</label>
                        <div class="input-group">
                            <input type="tel" 
                                   class="form-input" 
                                   @bind="phone" 
                                   placeholder="087 123 4567"
                                   maxlength="15" />
                            @if (phone.Length >= 9 && !isSearching)
                            {
                                <button class="btn-search" 
                                        @onclick="SearchByPhone" 
                                        type="button">
                                    üîç Buscar
                                </button>
                            }
                            @if (isSearching)
                            {
                                <button class="btn-search" type="button" disabled>
                                    üîÑ Buscando...
                                </button>
                            }
                        </div>
                        <small class="form-hint">Ingresa al menos 9 d√≠gitos y haz clic en Buscar</small>
                    </div>

                    <!-- Nombre -->
                    <div class="form-group">
                        <label class="form-label required">Nombre Completo</label>
                        <input type="text" 
                               class="form-input" 
                               @bind="name" 
                               placeholder="John Doe" />
                    </div>

                    <!-- Email -->
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" 
                               class="form-input" 
                               @bind="email" 
                               placeholder="cliente@ejemplo.com" />
                    </div>

                    <!-- Eircode Lookup -->
                    <div class="form-group">
                        <label class="form-label">Eircode (C√≥digo Postal Irland√©s)</label>
                        <div class="input-group">
                            <input type="text"
                                   class="form-input"
                                   @bind="eircode"
                                   @bind:event="oninput"
                                   placeholder="A92 X7Y8"
                                   maxlength="8"
                                   style="text-transform: uppercase;" />
                            <button class="btn-search btn-geocode"
                                    @onclick="GeocodeEircode"
                                    type="button"
                                    disabled="@(string.IsNullOrWhiteSpace(eircode) || isGeocodingEircode)">
                                @if (isGeocodingEircode)
                                {
                                    <span class="spinner-small"></span>
                                    <span>Buscando...</span>
                                }
                                else
                                {
                                    <span>üîç Buscar Direcci√≥n</span>
                                }
                            </button>
                        </div>
                        <small class="form-hint">Ingresa el Eircode y haz clic en "Buscar Direcci√≥n" para autocompletar</small>
                    </div>

                    <!-- Address Autocomplete (Fallback) -->
                    <div class="form-group">
                        <label class="form-label">O busca la direcci√≥n manualmente</label>
                        <div class="input-group">
                            <span class="input-icon">üìç</span>
                            <input type="text"
                                   id="address-autocomplete-input"
                                   class="form-input with-icon"
                                   placeholder="Empieza a escribir la direcci√≥n..."
                                   @ref="autocompleteInput" />
                            @if (hasAddress)
                            {
                                <span class="address-check">‚úì</span>
                            }
                        </div>
                        <small class="form-hint">Empieza a escribir para ver sugerencias de direcciones en Irlanda</small>
                    </div>

                    <!-- Direcci√≥n L√≠nea 1 -->
                    <div class="form-group">
                        <label class="form-label">Direcci√≥n (Calle y N√∫mero)</label>
                        <input type="text"
                               id="addressInput"
                               class="form-input"
                               @bind="addressLine1"
                               placeholder="123 Main Street" />
                    </div>

                    <!-- Direcci√≥n L√≠nea 2 -->
                    <div class="form-group">
                        <label class="form-label">Apartamento / Piso (opcional)</label>
                        <input type="text" 
                               class="form-input" 
                               @bind="addressLine2" 
                               placeholder="Apt 4B" />
                    </div>

                    <!-- Ciudad, County -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ciudad</label>
                            <input type="text"
                                   class="form-input"
                                   @bind="city"
                                   placeholder="Drogheda" />
                        </div>

                        <div class="form-group">
                            <label class="form-label">County</label>
                            <input type="text"
                                   class="form-input"
                                   @bind="county"
                                   placeholder="Louth" />
                        </div>
                    </div>

                    <!-- Notas -->
                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea class="form-textarea" 
                                  @bind="notes" 
                                  rows="3"
                                  placeholder="Instrucciones especiales, referencias, etc."></textarea>
                    </div>

                    <!-- Map Preview -->
                    @if (showMapPreview && latitude.HasValue && longitude.HasValue)
                    {
                        <div class="map-preview-container">
                            <div class="map-preview-header">
                                <span>üìç Ubicaci√≥n del Cliente</span>
                                <button class="btn-link" @onclick="ClearAddress" type="button">
                                    üóëÔ∏è Limpiar Direcci√≥n
                                </button>
                            </div>
                            <div id="map-preview" class="map-preview"></div>
                            <div class="map-attribution">
                                <small>Powered by Google Maps</small>
                            </div>
                            <div class="location-details">
                                <small>Coordenadas: @latitude.Value.ToString("F6"), @longitude.Value.ToString("F6")</small>
                            </div>
                        </div>
                    }
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="Cancel" type="button">
                    Cancelar
                </button>
                <button class="btn btn-primary" 
                        @onclick="SaveCustomer" 
                        type="button"
                        disabled="@(!IsValid() || isSaving)">
                    @(isSaving ? "Guardando..." : "Guardar")
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<Customer?> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public Customer? ExistingCustomer { get; set; }

    private bool IsEditMode => ExistingCustomer != null;
    private ElementReference modalElement;
    private ElementReference autocompleteInput;
    private bool isInitialRender = true;
    private bool _wasOpen = false; // Rastrear estado anterior

    private string phone = "";
    private string name = "";
    private string email = "";
    private string addressLine1 = "";
    private string addressLine2 = "";
    private string city = "Drogheda";
    private string county = "Louth";
    private string eircode = "";
    private string notes = "";
    private double? latitude;
    private double? longitude;

    private bool isSearching = false;
    private bool isGeocodingEircode = false;
    private bool isSaving = false;
    private string errorMessage = "";
    private Customer? existingCustomer = null;

    // Google Maps Autocomplete
    private DotNetObjectReference<CustomerModal>? dotNetRef;
    private bool mapsInitialized = false;
    private bool showMapPreview = false;
    private bool hasAddress => !string.IsNullOrEmpty(addressLine1) && latitude.HasValue && longitude.HasValue;

    protected override void OnParametersSet()
    {
        // CR√çTICO: Solo limpiar cuando el modal se abre por PRIMERA VEZ
        // No limpiar en renders subsiguientes mientras est√° abierto
        if (IsOpen && !_wasOpen) // Modal acaba de abrirse
        {
            Logger.LogInformation("üÜï Modal abierto por primera vez - Inicializando");

            // Prevenir cierre inmediato en el primer render
            isInitialRender = true;

            if (ExistingCustomer != null)
            {
                LoadCustomer(ExistingCustomer);
            }
            else
            {
                ClearForm();
            }

            // Permitir clicks despu√©s de 300ms
            Task.Delay(300).ContinueWith(_ => isInitialRender = false);
        }
        else if (!IsOpen && _wasOpen) // Modal acaba de cerrarse
        {
            Logger.LogInformation("üîí Modal cerrado - Limpiando estado");
            ClearForm();
        }

        // Actualizar estado anterior
        _wasOpen = IsOpen;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef = DotNetObjectReference.Create(this);
        }

        if (IsOpen && !mapsInitialized)
        {
            await InitializeGoogleMaps();
        }
    }

    private async Task InitializeGoogleMaps()
    {
        try
        {
            Logger.LogInformation("üó∫Ô∏è Inicializando Google Maps Autocomplete");

            // Check if Google Maps is loaded
            var isLoaded = await JS.InvokeAsync<bool>("isGoogleMapsLoaded");
            if (!isLoaded)
            {
                Logger.LogWarning("‚ö†Ô∏è Google Maps no est√° cargado a√∫n, esperando...");
                await Task.Delay(1000);
                return;
            }

            // Initialize autocomplete
            await JS.InvokeVoidAsync("googleMapsInterop.initAutocomplete",
                "address-autocomplete-input", dotNetRef);

            // Initialize map preview if coordinates exist
            if (latitude.HasValue && longitude.HasValue)
            {
                await JS.InvokeVoidAsync("googleMapsInterop.initMapPreview",
                    "map-preview", latitude.Value, longitude.Value);
                showMapPreview = true;
            }

            mapsInitialized = true;
            Logger.LogInformation("‚úÖ Google Maps inicializado correctamente");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "‚ùå Error inicializando Google Maps");
        }
    }

    [JSInvokable]
    public async Task OnPlaceSelected(JsonElement placeData)
    {
        try
        {
            Logger.LogInformation("üìç Lugar seleccionado desde autocomplete");

            // Extract data from JSON
            if (placeData.TryGetProperty("address_line1", out var addr1))
                addressLine1 = addr1.GetString() ?? "";

            if (placeData.TryGetProperty("address_line2", out var addr2))
                addressLine2 = addr2.GetString() ?? "";

            if (placeData.TryGetProperty("city", out var cityProp))
                city = cityProp.GetString() ?? "Drogheda";

            if (placeData.TryGetProperty("county", out var countyProp))
                county = countyProp.GetString() ?? "Louth";

            if (placeData.TryGetProperty("eircode", out var eircodeProp))
                eircode = eircodeProp.GetString() ?? "";

            if (placeData.TryGetProperty("latitude", out var latProp))
                latitude = latProp.GetDouble();

            if (placeData.TryGetProperty("longitude", out var lngProp))
                longitude = lngProp.GetDouble();

            Logger.LogInformation("‚úÖ Direcci√≥n completada: {Address}, {City}, {County}",
                addressLine1, city, county);

            // Update map preview
            if (latitude.HasValue && longitude.HasValue)
            {
                if (!showMapPreview)
                {
                    await JS.InvokeVoidAsync("googleMapsInterop.initMapPreview",
                        "map-preview", latitude.Value, longitude.Value);
                    showMapPreview = true;
                }
                else
                {
                    await JS.InvokeVoidAsync("googleMapsInterop.updateMapPreview",
                        latitude.Value, longitude.Value);
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error procesando lugar seleccionado");
            errorMessage = "Error al procesar la direcci√≥n seleccionada";
            StateHasChanged();
        }
    }

    private async Task ClearAddress()
    {
        Logger.LogInformation("üóëÔ∏è Limpiando direcci√≥n");

        addressLine1 = "";
        addressLine2 = "";
        city = "Drogheda";
        county = "Louth";
        eircode = "";
        latitude = null;
        longitude = null;
        showMapPreview = false;

        try
        {
            await JS.InvokeVoidAsync("googleMapsInterop.clearAutocomplete",
                "address-autocomplete-input");
            await JS.InvokeVoidAsync("googleMapsInterop.hideMap", "map-preview");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error limpiando autocomplete");
        }

        StateHasChanged();
    }

    private async Task GeocodeEircode()
    {
        if (string.IsNullOrWhiteSpace(eircode))
        {
            errorMessage = "Por favor ingresa un Eircode";
            return;
        }

        isGeocodingEircode = true;
        errorMessage = "";
        StateHasChanged();

        try
        {
            Logger.LogInformation("üîç Geocoding Eircode: {Eircode}", eircode);

            var result = await ApiService.GeocodeEircodeAsync(eircode);

            if (result == null)
            {
                errorMessage = "Error al buscar el Eircode. Por favor intenta de nuevo.";
                isGeocodingEircode = false;
                StateHasChanged();
                return;
            }

            if (!result.Found)
            {
                errorMessage = "Eircode not found - please enter address manually using the autocomplete field below";
                Logger.LogWarning("‚ùå Eircode no encontrado: {Eircode}", eircode);
                isGeocodingEircode = false;
                StateHasChanged();
                return;
            }

            // Success! Fill in the address fields
            Logger.LogInformation("‚úÖ Eircode geocoded successfully: {Address}", result.FormattedAddress);

            if (!string.IsNullOrEmpty(result.AddressLine1))
                addressLine1 = result.AddressLine1;

            if (!string.IsNullOrEmpty(result.AddressLine2))
                addressLine2 = result.AddressLine2;

            if (!string.IsNullOrEmpty(result.City))
                city = result.City;

            if (!string.IsNullOrEmpty(result.County))
                county = result.County;

            if (!string.IsNullOrEmpty(result.Eircode))
                eircode = result.Eircode;

            latitude = result.Latitude;
            longitude = result.Longitude;

            // Show map preview
            if (latitude.HasValue && longitude.HasValue)
            {
                if (!showMapPreview)
                {
                    await JS.InvokeVoidAsync("googleMapsInterop.initMapPreview",
                        "map-preview", latitude.Value, longitude.Value);
                    showMapPreview = true;
                }
                else
                {
                    await JS.InvokeVoidAsync("googleMapsInterop.updateMapPreview",
                        latitude.Value, longitude.Value);
                }
            }

            // Clear error message on success
            errorMessage = "";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error geocoding Eircode");
            errorMessage = "Error al buscar el Eircode: " + ex.Message;
        }
        finally
        {
            isGeocodingEircode = false;
            StateHasChanged();
        }
    }

    private async Task HandleBackdropClick()
    {
        // Solo cerrar si no es el render inicial
        if (!isInitialRender)
        {
            Logger.LogInformation("Click en backdrop - Cerrando modal");
            await Cancel();
        }
    }

    private void LoadCustomer(Customer customer)
    {
        phone = customer.Phone;
        name = customer.Name;
        email = customer.Email ?? "";
        addressLine1 = customer.AddressLine1 ?? "";
        addressLine2 = customer.AddressLine2 ?? "";
        city = customer.City;
        county = customer.County;
        eircode = customer.Eircode ?? "";
        notes = customer.Notes ?? "";
        latitude = customer.Latitude;
        longitude = customer.Longitude;
    }

    private void ClearForm()
    {
        Logger.LogInformation("üßπ ClearForm() llamado - Limpiando todos los campos");
        phone = "";
        name = "";
        email = "";
        addressLine1 = "";
        addressLine2 = "";
        city = "Drogheda";
        county = "Louth";
        eircode = "";
        notes = "";
        latitude = null;
        longitude = null;
        existingCustomer = null;
        errorMessage = "";
    }

    private async Task SearchByPhone()
    {
        if (string.IsNullOrWhiteSpace(phone) || phone.Length < 9)
        {
            errorMessage = "El tel√©fono debe tener al menos 9 d√≠gitos";
            return;
        }

        isSearching = true;
        errorMessage = "";
        existingCustomer = null;
        StateHasChanged();

        try
        {
            Logger.LogInformation("üîç Buscando cliente por tel√©fono: {Phone}", phone);
            var result = await ApiService.SearchCustomerByPhoneAsync(phone);
            
            if (result?.Found == true && result.Customer != null)
            {
                Logger.LogInformation("‚úÖ Cliente encontrado: {Name}", result.Customer.Name);
                existingCustomer = result.Customer;
            }
            else
            {
                Logger.LogInformation("‚ÑπÔ∏è No se encontr√≥ cliente con ese tel√©fono");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error buscando cliente");
            errorMessage = "Error al buscar cliente: " + ex.Message;
        }
        finally
        {
            isSearching = false;
            StateHasChanged();
        }
    }

    private async Task UseExistingCustomer()
    {
        if (existingCustomer != null)
        {
            await OnSave.InvokeAsync(existingCustomer);
        }
    }

    private void CreateNew()
    {
        existingCustomer = null;
    }


    private async Task SaveCustomer()
    {
        if (!IsValid()) return;

        isSaving = true;
        errorMessage = "";
        StateHasChanged();

        try
        {
            var customerData = new CustomerCreate
            {
                Phone = phone.Trim(),
                Name = name.Trim(),
                Email = string.IsNullOrWhiteSpace(email) ? null : email.Trim(),
                AddressLine1 = string.IsNullOrWhiteSpace(addressLine1) ? null : addressLine1.Trim(),
                AddressLine2 = string.IsNullOrWhiteSpace(addressLine2) ? null : addressLine2.Trim(),
                City = city.Trim(),
                County = county.Trim(),
                Eircode = string.IsNullOrWhiteSpace(eircode) ? null : eircode.Trim().ToUpper(),
                Latitude = latitude,
                Longitude = longitude,
                Notes = string.IsNullOrWhiteSpace(notes) ? null : notes.Trim()
            };

            Customer? result;
            if (IsEditMode && ExistingCustomer != null)
            {
                result = await ApiService.UpdateCustomerAsync(ExistingCustomer.Id, customerData);
            }
            else
            {
                result = await ApiService.CreateCustomerAsync(customerData);
            }

            if (result != null)
            {
                await OnSave.InvokeAsync(result);
                ClearForm();
            }
            else
            {
                errorMessage = "Error al guardar el cliente";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error guardando cliente");
            errorMessage = "Error al guardar: " + ex.Message;
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task Cancel()
    {
        Logger.LogInformation("üö´ CustomerModal.Cancel llamado - Limpiando y cerrando");
        ClearForm();
        await OnCancel.InvokeAsync();
    }

    private bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(phone) &&
               !string.IsNullOrWhiteSpace(name) &&
               phone.Length >= 9;
    }

    public void Dispose()
    {
        try
        {
            dotNetRef?.Dispose();
            // Clean up Google Maps resources
            if (mapsInitialized)
            {
                JS.InvokeVoidAsync("googleMapsInterop.dispose").AsTask().Wait(TimeSpan.FromSeconds(1));
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error disposing CustomerModal");
        }
    }
}