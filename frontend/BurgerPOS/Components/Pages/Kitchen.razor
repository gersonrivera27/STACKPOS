@page "/cocina"
@rendermode InteractiveServer
@using BurgerPOS.Models
@using BurgerPOS.Services
@inject PosApiService ApiService
@inject NavigationManager Navigation
@inject ILogger<Kitchen> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="pos-layout kitchen-layout">
    <!-- Header compartido pero adaptado -->
    <header class="pos-header">
        <div class="brand kitchen-brand">
            <div class="kitchen-brand-mark">
                <i class="bi bi-grid-3x3-gap-fill"></i>
            </div>
            <span class="brand-name">KITCHEN BOARD</span>
        </div>
        
        <div class="header-info">
            <div class="info-pill @(ordersPending.Count > 5 ? "badge-danger" : "")">
                <i class="bi bi-bell-fill icon"></i>
                <span class="text">Pendientes: <strong>@ordersPending.Count</strong></span>
            </div>
            <div class="info-pill">
                <i class="bi bi-fire icon"></i>
                <span class="text">Preparando: <strong>@ordersPreparing.Count</strong></span>
            </div>
        </div>

        <div class="kitchen-header-actions">
             <span class="kitchen-updated">Actualizado: @lastUpdated.ToString("HH:mm:ss")</span>
            <button class="btn-logout kitchen-home-btn" @onclick="GoHome">
                <i class="bi bi-house-door-fill"></i> HOME
            </button>
        </div>
    </header>

    <main class="pos-main kitchen-main">
        
        @if (isLoading && !ordersPending.Any() && !ordersPreparing.Any())
        {
            <div class="kitchen-loading">
                <div class="spinner"></div>
                <p>Cargando órdenes...</p>
            </div>
        }
        else
        {
            <div class="kitchen-board">
                <!-- Columna Pendientes -->
                <div class="kanban-column pending-col">
                    <div class="column-header">
                        <h2><i class="bi bi-hourglass-split"></i> PENDIENTES</h2>
                    </div>
                    <div class="column-content">
                        @if (ordersPending.Any())
                        {
                            @foreach (var order in ordersPending)
                            {
                                <div class="kitchen-card pending">
                                    <div class="card-header">
                                        <span class="order-id">#@order.OrderNumber</span>
                                        <span class="order-time">@GetTimeElapsed(order.CreatedAt)</span>
                                    </div>
                                    <div class="card-type">
                                        <span class="badge @GetBadgeClass(order.OrderType)">
                                            @GetOrderTypeLabel(order.OrderType)
                                            @(order.TableId.HasValue ? $" #{order.TableId}" : "")
                                        </span>
                                        <div class="card-meta">
                                            @if(!string.IsNullOrEmpty(order.WaiterName)) {
                                                <span class="waiter"><i class="bi bi-person-badge"></i> @order.WaiterName</span>
                                            }
                                            <span class="today-customer">@order.CustomerName</span>
                                        </div>
                                    </div>
                                    <div class="card-items">
                                        @if(order is OrderWithDetails details)
                                        {
                                            @foreach (var item in details.Items)
                                            {
                                                <div class="order-item">
                                                    <span class="qty">@item.Quantity</span>
                                                    <span class="name">@item.ProductName</span>
                                                    @if (!string.IsNullOrEmpty(item.SpecialInstructions))
                                                    {
                                                        <div class="modifiers"><i class="bi bi-exclamation-triangle-fill"></i> @item.SpecialInstructions</div>
                                                    }
                                                    @if(item.Modifiers != null && item.Modifiers.Any())
                                                    {
                                                        @foreach(var mod in item.Modifiers)
                                                        {
                                                            <div class="modifiers modifier-option"><i class="bi bi-plus-circle"></i> @mod.ModifierName</div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        }
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-action start" @onclick="@(() => UpdateStatus(order.Id, "preparing"))">
                                            <i class="bi bi-play-circle-fill"></i> EMPEZAR
                                        </button>
                                        <button class="btn-action print" title="Imprimir Comanda" @onclick="@(async () => await JSRuntime.InvokeVoidAsync("open", $"/print/receipt/{order.Id}", "_blank"))">
                                            <i class="bi bi-printer-fill"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-state">
                                <i class="bi bi-check-circle"></i>
                                <p>No hay órdenes pendientes</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Columna En Preparación -->
                <div class="kanban-column preparing-col">
                    <div class="column-header">
                        <h2><i class="bi bi-fire"></i> EN PREPARACIÓN</h2>
                    </div>
                    <div class="column-content">
                        @if (ordersPreparing.Any())
                        {
                            @foreach (var order in ordersPreparing)
                            {
                                <div class="kitchen-card preparing">
                                    <div class="card-header">
                                        <span class="order-id">#@order.OrderNumber</span>
                                        <span class="order-time">@GetTimeElapsed(order.CreatedAt)</span>
                                    </div>
                                    <div class="card-type">
                                        <span class="badge @GetBadgeClass(order.OrderType)">
                                            @GetOrderTypeLabel(order.OrderType)
                                        </span>
                                        <span class="today-customer">@order.CustomerName</span>
                                    </div>
                                    <div class="card-items">
                                        @if(order is OrderWithDetails details)
                                        {
                                            @foreach (var item in details.Items)
                                            {
                                                <div class="order-item">
                                                    <span class="qty">@item.Quantity</span>
                                                    <span class="name">@item.ProductName</span>
                                                    @if (!string.IsNullOrEmpty(item.SpecialInstructions))
                                                    {
                                                        <div class="modifiers"><i class="bi bi-exclamation-triangle-fill"></i> @item.SpecialInstructions</div>
                                                    }
                                                    @if(item.Modifiers != null && item.Modifiers.Any())
                                                    {
                                                        @foreach(var mod in item.Modifiers)
                                                        {
                                                             <div class="modifiers modifier-option"><i class="bi bi-plus-circle"></i> @mod.ModifierName</div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        }
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-action finish" @onclick="@(() => UpdateStatus(order.Id, "ready"))">
                                            <i class="bi bi-check2-circle"></i> LISTO
                                        </button>
                                        <button class="btn-action print" title="Imprimir Comanda" @onclick="@(async () => await JSRuntime.InvokeVoidAsync("open", $"/print/receipt/{order.Id}", "_blank"))">
                                            <i class="bi bi-printer-fill"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-state">
                                <i class="bi bi-fire"></i>
                                <p>Nada en preparación</p>
                            </div>
                        }
                    </div>
                </div>
                
                <!-- Columna Listos (completados en cocina, pendientes de pago) -->
                <div class="kanban-column completed-col">
                    <div class="column-header">
                        <h2><i class="bi bi-check2-square"></i> LISTOS (@ordersCompleted.Count)</h2>
                    </div>
                    <div class="column-content">
                        @if (ordersCompleted.Any())
                        {
                            @foreach (var order in ordersCompleted)
                            {
                                <div class="kitchen-card completed">
                                    <div class="card-header">
                                        <span class="order-id">#@order.OrderNumber</span>
                                        <span class="order-time ready-time">
                                            Listo: @(order.CompletedAt?.ToString("HH:mm") ?? "-")
                                        </span>
                                    </div>
                                    <div class="card-type">
                                        <span class="today-customer">@order.CustomerName</span>
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-action undo" @onclick="@(() => UpdateStatus(order.Id, "preparing"))">
                                            <i class="bi bi-arrow-counterclockwise"></i> DESHACER
                                        </button>
                                        @if (!IsPaid(order))
                                        {
                                            <span class="badge-payment unpaid">UNPAID</span>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        }
    </main>
</div>

@code {
    private List<Order> ordersPending = new();
    private List<Order> ordersPreparing = new();
    private List<Order> ordersCompleted = new();
    private bool isLoading = true;
    private DateTime lastUpdated = DateTime.Now;
    
    private System.Net.WebSockets.ClientWebSocket _webSocket = new();
    private System.Threading.CancellationTokenSource _cts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrders();
        _ = ConnectWebSocket();
    }

    private async Task ConnectWebSocket()
    {
        try
        {
            var apiUrl = Environment.GetEnvironmentVariable("API_URL") ?? "http://localhost:8000";
            var wsUrl = apiUrl.Replace("http://", "ws://").Replace("https://", "wss://") + "/api/ws";
            
            Logger.LogInformation($"Conectando WebSocket KDS a: {wsUrl}");
            await _webSocket.ConnectAsync(new Uri(wsUrl), _cts.Token);
            
            var buffer = new byte[1024 * 4];
            while (_webSocket.State == System.Net.WebSockets.WebSocketState.Open && !_cts.Token.IsCancellationRequested)
            {
                var result = await _webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), _cts.Token);
                if (result.MessageType == System.Net.WebSockets.WebSocketMessageType.Text)
                {
                    var message = System.Text.Encoding.UTF8.GetString(buffer, 0, result.Count);
                    try 
                    {
                        var doc = System.Text.Json.JsonDocument.Parse(message);
                        if (doc.RootElement.TryGetProperty("type", out var typeElement))
                        {
                            var eventType = typeElement.GetString();
                            if (eventType == "order_updated" || eventType == "kitchen_update" || 
                                eventType == "order_created" || eventType == "order_status_changed")
                            {
                                await InvokeAsync(async () => 
                                {
                                    await LoadOrders(false);
                                    StateHasChanged();
                                });
                            }
                        }
                    } 
                    catch (Exception ex) 
                    {
                        Logger.LogWarning(ex, "Error parseando mensaje WS");
                    }
                }
                else if (result.MessageType == System.Net.WebSockets.WebSocketMessageType.Close)
                {
                    await _webSocket.CloseAsync(System.Net.WebSockets.WebSocketCloseStatus.NormalClosure, string.Empty, System.Threading.CancellationToken.None);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error en WebSocket de KDS");
            // Reconnect after 5 seconds
            if (!_cts.Token.IsCancellationRequested) 
            {
                await Task.Delay(5000);
                if (_webSocket.State != System.Net.WebSockets.WebSocketState.Open) {
                    _webSocket.Dispose();
                    _webSocket = new System.Net.WebSockets.ClientWebSocket();
                    _ = ConnectWebSocket();
                }
            }
        }
    }

    private async Task LoadOrders(bool showLoading = true)
    {
        if (showLoading) isLoading = true;
        try
        {
            var p_orders = await ApiService.GetOrdersAsync("pending");
            var prep_orders = await ApiService.GetOrdersAsync("preparing");
            var comp_orders = await ApiService.GetOrdersAsync("ready"); 

            ordersPending = await EnrichOrders(p_orders);
            ordersPreparing = await EnrichOrders(prep_orders);
            ordersCompleted = comp_orders.Take(5).ToList(); 

            lastUpdated = DateTime.Now;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading kitchen orders");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task<List<Order>> EnrichOrders(List<Order> orders)
    {
        var enriched = new List<Order>();
         // Optimize? Parallel fetch?
        foreach (var o in orders)
        {
            var details = await ApiService.GetOrderAsync(o.Id);
            if (details != null) enriched.Add(details);
        }
        return enriched;
    }

    private async Task UpdateStatus(int orderId, string newStatus)
    {
        try
        {
            await ApiService.UpdateOrderStatusAsync(orderId, newStatus);
            // We no longer manually reload here because the websocket will broadcast back to us!
            // But we can eagerly load to make UI feel snappier.
            await LoadOrders(false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating order status");
        }
    }

    private string GetTimeElapsed(DateTime createdAt)
    {
        var diff = DateTime.Now - createdAt;
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m";
        return $"{(int)diff.TotalHours}h";
    }

    private string GetOrderTypeLabel(string type)
    {
        return type switch
        {
            "dine_in" => "MESA",
            "takeout" => "LLEVAR",
            "collection" => "RECOGER",
            "delivery" => "DOMICILIO",
            _ => type.ToUpper()
        };
    }
    
    private string GetBadgeClass(string type)
    {
        return type switch
        {
             "dine_in" => "badge-info", // need to check app.css badges or just use kitchen specific
             "takeout" => "badge-success",
             "delivery" => "badge-danger",
             _ => "badge-warning"
        };
    }

    public void Dispose()
    {
        _cts.Cancel();
        _webSocket?.Dispose();
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }

    private bool IsPaid(Order order) => order.HasPayment || !string.IsNullOrEmpty(order.PaymentMethod);
}
