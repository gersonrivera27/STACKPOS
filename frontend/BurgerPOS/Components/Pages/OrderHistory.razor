@page "/ordenes"
@rendermode InteractiveServer
@using BurgerPOS.Models
@using BurgerPOS.Services
@using BurgerPOS.Components.Shared
@inject PosApiService ApiService
@inject NavigationManager Navigation
@inject ILogger<OrderHistory> Logger
@inject IJSRuntime JSRuntime
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider

<div class="order-history-container">
    <!-- 1. Top Bar: Controls & Filters -->
    <div class="history-top-bar">
        <div class="filter-group">
            <div class="filter-item">
                <label>BUSCAR ORDEN #</label>
                <input type="text" placeholder="ID..." @bind="searchId" @bind:event="oninput" />
            </div>
            <div class="filter-item">
                <label>TEL√âFONO</label>
                <input type="text" placeholder="08..." @bind="searchPhone" @bind:event="oninput" />
            </div>
            <div class="filter-item">
                <label>ESTADO</label>
                <select @bind="filterStatus">
                    <option value="">TODOS</option>
                    <option value="pending">PENDIENTE</option>
                    <option value="preparing">PREPARANDO</option>
                    <option value="completed">COMPLETADO</option>
                    <option value="cancelled">CANCELADO</option>
                </select>
            </div>
            <button class="btn-search" @onclick="LoadOrders">
                üîç BUSCAR
            </button>
            
            @if (isAdmin)
            {
                <div class="filter-item checkbox-item">
                    <input type="checkbox" id="chkHistory" @bind="showHistory" />
                    <label for="chkHistory">VER HISTORIAL COMPLETO</label>
                </div>
            }
        </div>

        <div class="action-group">
            @if (selectedOrder != null)
            {
                <div class="selected-indicator">
                    @if (selectedOrder.OrderType == "delivery")
                    {
                        <span class="type-icon">üöó</span>
                    }
                    else if (selectedOrder.OrderType == "takeout")
                    {
                        <span class="type-icon">ü•°</span>
                    }
                    else
                    {
                        <span class="type-icon">üçΩÔ∏è</span>
                    }
                    <div class="selected-info">
                        <span class="selected-id">#@selectedOrder.OrderNumber</span>
                        <span class="selected-status @selectedOrder.Status.ToLower()">@selectedOrder.Status.ToUpper()</span>
                    </div>
                </div>
                
                <button class="btn-action btn-print" @onclick="PrintTicket">
                    üñ®Ô∏è IMPRIMIR
                </button>
                
                @if (selectedOrder.Status != "completed" && selectedOrder.Status != "cancelled")
                {
                    <button class="btn-action btn-pay" @onclick="OpenPaymentModal">
                        üí∞ PAGAR
                    </button>
                }
            }
            
            <button class="btn-action btn-close" @onclick="GoHome">
                ‚úï SALIR
            </button>
        </div>
    </div>

    <div class="history-content">
        <!-- 2. Left Panel: Receipt View (35%) -->
        <div class="receipt-panel" id="receipt-area">
            @if (selectedOrder != null)
            {
                <div class="receipt-header">
                    <h3>STACK POS</h3>
                    <p>123 Burger Street, Dublin</p>
                    <p>Tel: 01 234 5678</p>
                    <div class="receipt-divider">================================</div>
                    <p>ORDEN: #@selectedOrder.OrderNumber</p>
                    <p>FECHA: @selectedOrder.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                    <p>CLIENTE: @selectedOrder.CustomerName</p>
                    <div class="receipt-divider">================================</div>
                </div>

                <div class="receipt-items">
                    <table class="receipt-table">
                        <thead>
                            <tr>
                                <th class="col-qty">QTY</th>
                                <th class="col-desc">DESC</th>
                                <th class="col-price">AMT</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (selectedOrder is OrderWithDetails details)
                            {
                                @foreach (var item in details.Items)
                                {
                                    <tr>
                                        <td class="col-qty">@item.Quantity</td>
                                        <td class="col-desc">@item.ProductName</td>
                                        <td class="col-price">@item.Subtotal.ToString("F2")</td>
                                    </tr>
                                    @if (!string.IsNullOrEmpty(item.SpecialInstructions))
                                    {
                                        <tr>
                                            <td></td>
                                            <td colspan="2" class="receipt-modifier">>> @item.SpecialInstructions</td>
                                        </tr>
                                    }
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" style="text-align:center; padding: 20px;">
                                        Cargando detalles...
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="receipt-footer">
                    <div class="receipt-divider">================================</div>
                    <div class="receipt-line">
                        <span>SUBTOTAL:</span>
                        <span>@selectedOrder.Subtotal.ToString("F2")</span>
                    </div>
                    <div class="receipt-line">
                        <span>TAX (13.5%):</span>
                        <span>@selectedOrder.Tax.ToString("F2")</span>
                    </div>
                    <div class="receipt-line total-line">
                        <span>TOTAL:</span>
                        <span>@selectedOrder.Total.ToString("F2")</span>
                    </div>
                    <div class="receipt-divider">================================</div>
                    <p class="receipt-thankyou">*** GRACIAS POR SU COMPRA ***</p>
                </div>
            }
            else
            {
                <div class="no-selection">
                    <p>Seleccione una orden para ver el ticket</p>
                </div>
            }
        </div>

        <!-- 3. Right Panel: Order List (65%) -->
        <div class="order-list-panel">
            <table class="grid-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>CLIENTE</th>
                        <th>TIPO</th>
                        <th>ESTADO</th>
                        <th>HORA</th>
                        <th class="text-right">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    @if (isLoading)
                    {
                        <tr><td colspan="6" class="text-center">Cargando √≥rdenes...</td></tr>
                    }
                    else if (orders.Any())
                    {
                        @foreach (var order in orders)
                        {
                            <tr class="@(selectedOrder?.Id == order.Id ? "selected" : "")" 
                                @onclick="() => SelectOrder(order)">
                                <td>@order.OrderNumber</td>
                                <td>@order.CustomerName</td>
                                <td>
                                    <span class="badge-type @order.OrderType.ToLower()">@order.OrderType.ToUpper()</span>
                                </td>
                                <td>
                                    <span class="badge-status @order.Status.ToLower()">@order.Status.ToUpper()</span>
                                </td>
                                <td>@order.CreatedAt.ToString("HH:mm")</td>
                                <td class="text-right">@order.Total.ToString("F2")</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="6" class="text-center">No se encontraron √≥rdenes.</td></tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@* Payment Modal - Usando componente compartido *@
@if (showPaymentModal && selectedOrder != null)
{
    <PaymentModal 
        Subtotal="selectedOrder.Subtotal"
        Tax="selectedOrder.Tax"
        Total="selectedOrder.Total"
        OrderId="selectedOrder.Id"
        OnClose="ClosePaymentModal"
        OnPaymentConfirmed="HandlePaymentConfirmed" />
}

@code {
    private List<Order> orders = new();
    private Order? selectedOrder;
    private bool isLoading = false;

    // Filters
    private string searchId = "";
    private string searchPhone = "";
    private string filterStatus = "";

    // Payment Modal
    private bool showPaymentModal = false;

    // Admin features
    private bool isAdmin = false;
    private bool showHistory = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.Identity?.IsAuthenticated == true && user.IsInRole("admin");
        
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        try
        {
            // If showHistory is TRUE (and user is admin), ONLY_ACTIVE_SESSION is FALSE.
            // If showHistory is FALSE, ONLY_ACTIVE_SESSION is TRUE.
            // For non-admins, showHistory is always false.
            bool onlyActive = !showHistory;
            
            orders = await ApiService.GetOrdersAsync(
                status: string.IsNullOrEmpty(filterStatus) ? null : filterStatus,
                activeSessionOnly: onlyActive
            );
            
            if (!string.IsNullOrEmpty(searchId))
            {
                orders = orders.Where(o => o.OrderNumber.Contains(searchId, StringComparison.OrdinalIgnoreCase)).ToList();
            }
            
            // Re-select order if it was updated
            if (selectedOrder != null)
            {
                var updated = orders.FirstOrDefault(o => o.Id == selectedOrder.Id);
                if (updated != null)
                {
                    // Keep details if we had them
                    if (selectedOrder is OrderWithDetails && !(updated is OrderWithDetails))
                    {
                         // We need to re-fetch details if we want to keep them, 
                         // but for now let's just update the base info
                         // Or better, just keep selectedOrder as is until user clicks another
                    }
                    else 
                    {
                        selectedOrder = updated;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading orders");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SelectOrder(Order order)
    {
        selectedOrder = order;
        try 
        {
            var details = await ApiService.GetOrderAsync(order.Id);
            if (details != null)
            {
                selectedOrder = details;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading order details");
        }
    }

    private async Task PrintTicket()
    {
        if (selectedOrder != null)
        {
            await JSRuntime.InvokeVoidAsync("open", $"/print/receipt/{selectedOrder.Id}", "_blank");
        }
    }

    // Payment Logic
    private void OpenPaymentModal()
    {
        if (selectedOrder == null) return;
        showPaymentModal = true;
    }

    private void ClosePaymentModal()
    {
        showPaymentModal = false;
    }

    private async Task HandlePaymentConfirmed(PaymentModal.PaymentResult result)
    {
        try
        {
            Logger.LogInformation("Procesando pago para orden {OrderId}", result.OrderId);

            var payment = new PaymentCreate
            {
                OrderId = result.OrderId,
                PaymentType = result.PaymentType,
                CashAmount = result.CashAmount,
                CardAmount = result.CardAmount,
                TipAmount = result.TipAmount
            };

            var paymentResponse = await ApiService.CreatePaymentAsync(payment);

            if (paymentResponse != null)
            {
                Logger.LogInformation("Pago procesado exitosamente. Cambio: {Change}", paymentResponse.ChangeAmount);
                showPaymentModal = false;
                await LoadOrders(); // Refresh list
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error procesando pago");
        }
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }
}
