@page "/"
@using BurgerPOS.Services
@using BurgerPOS.Models
@using BurgerPOS.Components.Shared
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject PosApiService ApiService
@inject NavigationManager Navigation
@inject ILogger<Home> Logger
@rendermode InteractiveServer

<PageTitle>StackPos - Sistema de Punto de Venta</PageTitle>



<div class="pos-layout">
    <!-- 1. Header -->
    <header class="pos-header">
        <div class="brand">
            <div class="brand-icon"></div>
            <span class="brand-name"><strong>STACK</strong> POS</span>
        </div>
        
        <div class="header-info">
            <div class="info-pill">
                <i class="bi bi-person-circle icon"></i>
                <span class="text">Admin</span>
            </div>
            <div class="info-pill">
                <i class="bi bi-shop icon"></i>
                <span class="text">Principal</span>
            </div>
            <div class="info-pill time-pill">
                @currentTime
            </div>
        </div>

            
    </header>

    <!-- 2. Main Content -->
    <main class="pos-main">
        <!-- Lines Grid -->
        <div class="lines-grid">
            @foreach (var line in lines)
            {
                <div class="line-card @(line.IsActive ? "active" : "")">
                    <div class="line-header">
                        <span class="line-id">L√≠nea @line.Id</span>
                        <span class="line-status">@(line.IsActive ? "OCUPADO" : "LIBRE")</span>
                    </div>
                    
                    <div class="line-icon-wrapper">
                        <i class="bi bi-telephone-fill line-icon"></i>
                    </div>

                    <div class="line-controls">
                        <button class="control-btn btn-delivery" 
                                @onclick="@(() => OpenCustomerModal(line.Id, "delivery"))">
                            <i class="bi bi-car-front-fill"></i>
                            <span>DOMICILIO</span>
                        </button>
                        <button class="control-btn btn-collection" 
                                @onclick="@(() => OpenCustomerModal(line.Id, "collection"))">
                            <i class="bi bi-bag-fill"></i>
                            <span>PARA LLEVAR</span>
                        </button>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <aside class="pos-sidebar">
            <button class="btn-takeaway" @onclick="@(() => Navigation.NavigateTo("/order/0/takeout/0"))">
                <i class="bi bi-person-walking takeaway-icon"></i>
                <span class="takeaway-text">TAKE AWAY</span>
                <span class="takeaway-sub">Venta R√°pida</span>
            </button>

            <div class="system-status">
                <div class="status-row">
                    <span class="status-label">SERVER</span>
                    <span class="status-led @(backendConnected ? "led-green" : "led-red")"></span>
                </div>
                <div class="status-row">
                    <span class="status-label">PRINTER</span>
                    <span class="status-led led-green"></span>
                </div>
                <div class="status-row">
                    <span class="status-label">DB SYNC</span>
                    <span class="status-led led-green"></span>
                </div>
            </div>
        </aside>
    </main>

    <!-- 3. Footer -->
    <footer class="pos-footer">
        <div class="actions-bar">
            <button class="action-key" @onclick="@(() => Navigation.NavigateTo("/productos"))">
                <span class="key-hint">F1</span>
                <span class="key-label">PRODUCTOS</span>
            </button>
            
            <button class="action-key" @onclick="@(() => Navigation.NavigateTo("/ordenes"))">
                <span class="key-hint">F2</span>
                <span class="key-label">√ìRDENES</span>
            </button>
            
            <button class="action-key" @onclick="@(() => Navigation.NavigateTo("/historial"))">
                <span class="key-hint">F3</span>
                <span class="key-label">HISTORIAL</span>
            </button>
            
            <button class="action-key" @onclick="@(() => Navigation.NavigateTo("/mesas"))">
                <span class="key-hint">F4</span>
                <span class="key-label">MESAS</span>
            </button>
            
            <button class="action-key" @onclick="@(() => Navigation.NavigateTo("/caja"))">
                <span class="key-hint">F5</span>
                <span class="key-label">CAJA</span>
            </button>
            
            <button class="action-key" @onclick="@(() => Navigation.NavigateTo("/clientes"))">
                <span class="key-hint">F6</span>
                <span class="key-label">CLIENTES</span>
            </button>
            
            <button class="action-key" @onclick="@(() => Navigation.NavigateTo("/cocina"))">
                <span class="key-hint">F7</span>
                <span class="key-label">COCINA</span>
            </button>
            
            <button class="action-key">
                <span class="key-hint">F8</span>
                <span class="key-label">CONFIG</span>
            </button>
        </div>
    </footer>
</div>

<!-- Customer Search Modal -->
<CustomerSearchModal IsOpen="@showCustomerModal"
                     PhoneLine="@selectedLineId"
                     OnContinue="HandleCustomerSelected"
                     OnCancel="CloseCustomerModal" />

@code {
    private bool backendConnected = false;
    private string currentTime = DateTime.Now.ToString("HH:mm:ss");
    private System.Timers.Timer? timer;
    
    private bool showCustomerModal = false;
    private int selectedLineId = 0;
    private string selectedOrderType = "";

    private List<OrderLine> lines = new()
    {
        new OrderLine { Id = 1, Name = "Line 1", IsActive = false },
        new OrderLine { Id = 2, Name = "Line 2", IsActive = false },
        new OrderLine { Id = 3, Name = "Line 3", IsActive = false },
        new OrderLine { Id = 4, Name = "Line 4", IsActive = false }
    };

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("üöÄ Iniciando POS Home");
        
        // Test backend connection
        try
        {
            backendConnected = await ApiService.TestConnectionAsync();
            Logger.LogInformation("Backend: {Status}", backendConnected ? "Conectado" : "Desconectado");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error conectando al backend");
        }

        // Iniciar reloj
        timer = new System.Timers.Timer(1000);
        timer.Elapsed += async (sender, e) => 
        {
            var newTime = DateTime.Now.ToString("HH:mm:ss");
            if (newTime != currentTime)
            {
                currentTime = newTime;
                await InvokeAsync(StateHasChanged);
            }
        };
        timer.Start();
    }

    private void OpenCustomerModal(int lineId, string orderType)
    {
        Logger.LogInformation("üìã Home.OpenCustomerModal INICIANDO - L√≠nea: {Line}, Tipo: {Type}, Modal abierto: {IsOpen}", 
            lineId, orderType, showCustomerModal);
        
        // IMPORTANTE: Cerrar primero si ya est√° abierto
        if (showCustomerModal)
        {
            Logger.LogWarning("‚ö†Ô∏è Modal ya estaba abierto - cerrando primero");
            showCustomerModal = false;
            StateHasChanged();
            
            // Peque√±o delay para asegurar que se cierre
            Task.Delay(100).ContinueWith(_ => InvokeAsync(() => 
            {
                OpenModalInternal(lineId, orderType);
            }));
        }
        else
        {
            OpenModalInternal(lineId, orderType);
        }
    }

    private void OpenModalInternal(int lineId, string orderType)
    {
        selectedLineId = lineId;
        selectedOrderType = orderType;
        showCustomerModal = true;
        
        // Activar la l√≠nea si no es Take Away (lineId = 0)
        if (lineId > 0)
        {
            foreach (var line in lines)
            {
                line.IsActive = line.Id == lineId;
            }
        }

        StateHasChanged();
        
        Logger.LogInformation("‚úÖ Home.OpenCustomerModal COMPLETADO - Modal ahora: {IsOpen}", showCustomerModal);
    }

    private void CloseCustomerModal()
    {
        Logger.LogInformation("‚ùå Home.CloseCustomerModal - Cerrando modal (estaba: {Previous})", showCustomerModal);
        
        showCustomerModal = false;
        selectedLineId = 0;
        selectedOrderType = "";
        
        // Desactivar todas las l√≠neas
        foreach (var line in lines)
        {
            line.IsActive = false;
        }
        
        StateHasChanged();
        
        Logger.LogInformation("‚úÖ Modal cerrado - estado actual: {IsOpen}", showCustomerModal);
    }

    private void HandleCustomerSelected((Customer customer, string orderType) data)
    {
        Logger.LogInformation("‚úÖ Cliente seleccionado: {Name} ({Phone}) - Tipo: {Type}", 
            data.customer.Name, data.customer.Phone, data.orderType);
        
        // Cerrar modal PRIMERO
        CloseCustomerModal();
        
        // Navegar a crear orden con informaci√≥n del cliente
        var queryParams = new Dictionary<string, string?>
        {
            ["customerId"] = data.customer.Id.ToString(),
            ["type"] = data.orderType
        };
        
        if (selectedLineId > 0)
        {
            queryParams["line"] = selectedLineId.ToString();
        }
        
        var query = string.Join("&", queryParams.Select(kvp => $"{kvp.Key}={kvp.Value}"));
        
        Logger.LogInformation("üöÄ Navegando a: /nueva-orden?{Query}", query);
        Navigation.NavigateTo($"/nueva-orden?{query}");
    }

    public void Dispose()
    {
        Logger.LogInformation("üßπ Limpiando Home - Deteniendo timer");
        timer?.Stop();
        timer?.Dispose();
    }

    private class OrderLine
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public bool IsActive { get; set; }
    }
}
