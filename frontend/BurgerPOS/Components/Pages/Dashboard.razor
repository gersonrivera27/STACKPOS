@page "/dashboard"
@rendermode InteractiveServer
@using BurgerPOS.Models
@using BurgerPOS.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "admin")]
@inject PosApiService ApiService
@inject NavigationManager Navigation
@inject ILogger<Dashboard> Logger

<div class="dashboard-container modern-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="dashboard-title">
            <h1><i class="bi bi-graph-up-arrow"></i> Reporte de Ventas</h1>
        </div>
        <div class="date-controls">
            <button class="btn btn-secondary" @onclick="PreviousDay"><i class="bi bi-chevron-left"></i></button>
            <input type="date" class="date-input" value="@selectedDate.ToString("yyyy-MM-dd")" @onchange="OnDateChanged" />
            <button class="btn btn-secondary" @onclick="NextDay" disabled="@(selectedDate.Date >= DateTime.Today)"><i class="bi bi-chevron-right"></i></button>
            <button class="btn btn-primary" @onclick="LoadToday">Hoy</button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container dashboard-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else if (dailySales != null)
    {
        <!-- Summary Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon sales"><i class="bi bi-currency-euro"></i></div>
                <div class="stat-info">
                    <h3>Venta Total</h3>
                    <div class="stat-value">€@dailySales.Summary.TotalSales.ToString("F2")</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon orders"><i class="bi bi-receipt"></i></div>
                <div class="stat-info">
                    <h3>Órdenes</h3>
                    <div class="stat-value">@dailySales.Summary.TotalOrders</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon ticket"><i class="bi bi-calculator"></i></div>
                <div class="stat-info">
                    <h3>Ticket Promedio</h3>
                    <div class="stat-value">€@dailySales.Summary.AverageTicket.ToString("F2")</div>
                </div>
            </div>

            <div class="stat-card">
                 <div class="stat-icon cancel"><i class="bi bi-x-circle"></i></div>
                 <div class="stat-info">
                    <h3>Canceladas</h3>
                    <div class="stat-value stat-value-cancel">@dailySales.Summary.CancelledOrders</div>
                 </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Top Products -->
            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="bi bi-stars"></i> Productos Más Vendidos</h2>
                </div>
                
                @if (topProducts != null && topProducts.TopProducts.Any())
                {
                    <div class="progress-list">
                        @{
                            var maxQty = topProducts.TopProducts.Max(p => p.TotalQuantity); // Para calcular porcentaje
                            if(maxQty == 0) maxQty=1;
                        }
                        
                        @foreach (var prod in topProducts.TopProducts)
                        {
                            var percentage = (double)prod.TotalQuantity / maxQty * 100;
                            var barClass = percentage > 80 ? "gradient-3" : (percentage > 50 ? "gradient-2" : "gradient-1");
                            
                            <div class="progress-item">
                                <div class="progress-info">
                                    <span>@prod.Name</span>
                                    <span>@prod.TotalQuantity uds</span>
                                </div>
                                <div class="progress-meta">
                                    @prod.Category • €@prod.TotalRevenue.ToString("F2")
                                </div>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill @barClass" style="width: @percentage%"></div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <i class="bi bi-basket"></i>
                        <p>No hay datos de productos hoy</p>
                    </div>
                }
            </div>

            <!-- Sales By Type -->
            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="bi bi-bar-chart-fill"></i> Por Tipo de Orden</h2>
                </div>
                
                @if (dailySales.ByOrderType.Any())
                {
                    <div class="progress-list">
                         @{
                            var maxTotal = dailySales.ByOrderType.Max(t => t.Total); 
                            if(maxTotal == 0) maxTotal=1;
                        }

                        @foreach (var type in dailySales.ByOrderType)
                        {
                            var typeName = type.OrderType switch {
                                "delivery" => "Domicilio",
                                "takeout" => "Para Llevar",
                                "dine_in" => "Mesa",
                                _ => type.OrderType
                            };
                            
                            var icon = type.OrderType switch {
                                "delivery" => "bi-bicycle",
                                "takeout" => "bi-bag",
                                "dine_in" => "bi-shop",
                                _ => "bi-question-circle"
                            };

                            var percentage = (double)type.Total / (double)maxTotal * 100;
                            
                             <div class="progress-item progress-item-type">
                                <div class="progress-info progress-info-type">
                                    <span class="type-name">
                                        <i class="bi @icon type-icon"></i> 
                                        @typeName
                                    </span>
                                    <span class="type-total">€@type.Total.ToString("F2")</span>
                                </div>
                                <div class="progress-meta progress-meta-type">
                                    @type.Count órdenes
                                </div>
                             </div>
                        }
                    </div>
                }
                 else
                {
                     <div class="empty-state">
                        <i class="bi bi-pie-chart"></i>
                        <p>No hay ventas registradas</p>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    private DateTime selectedDate = DateTime.Today;
    private DailySalesResponse? dailySales;
    private TopProductsResponse? topProducts;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task OnDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out DateTime date))
        {
            selectedDate = date;
            await LoadData();
        }
    }

    private async Task PreviousDay()
    {
        selectedDate = selectedDate.AddDays(-1);
        await LoadData();
    }

    private async Task NextDay()
    {
        selectedDate = selectedDate.AddDays(1);
        await LoadData();
    }

    private async Task LoadToday()
    {
        selectedDate = DateTime.Today;
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            // Load summaries and top products in parallel
            var salesTask = ApiService.GetDailySalesReportAsync(selectedDate);
            var productsTask = ApiService.GetTopProductsReportAsync(selectedDate, selectedDate, 5); // Top 5 for today
            
            await Task.WhenAll(salesTask, productsTask);
            
            dailySales = await salesTask;
            topProducts = await productsTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error cargando dashboard");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
