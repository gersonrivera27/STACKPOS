@page "/order/create"
@page "/order/create/{OrderId:int}"
@page "/order/{CustomerId:int}/{OrderTypeStr}/{PhoneLine:int}"
@rendermode InteractiveServer
@using BurgerPOS.Models
@using BurgerPOS.Services
@using BurgerPOS.Components.Shared
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject PosApiService ApiService
@inject NavigationManager Navigation
@inject ILogger<OrderCreation> Logger
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider

<div class="order-creation-container">
    <!-- Header -->
    <div class="order-header">
        <div class="brand">
            <div class="brand-icon"></div>
            <span class="brand-name"><strong>STACK</strong> POS</span>
        </div>
        
        <div class="order-info-center">
            @if (OrderId.HasValue)
            {
                <span class="order-title editing-badge">‚úèÔ∏è EDITANDO ORDEN #@OrderId</span>
            }
            else
            {
                <span class="order-title">L√çNEA @PhoneLine - @GetOrderTypeLabel().ToUpper()</span>
            }
            @if (customer != null)
            {
                <span class="customer-name"> | üë§ @customer.Name</span>
            }
        </div>

        <button class="btn-close-order" @onclick="CancelOrder">
            ‚úï SALIR
        </button>
    </div>

    <div class="order-content">
        <!-- Left: Categories & Products (65%) -->
        <div class="products-section">
            <!-- Category Tabs -->
            <div class="category-tabs">
                @foreach (var category in categories)
                {
                    <button class="category-tab @(selectedCategoryId == category.Id ? "active" : "")"
                            @onclick="() => SelectCategory(category.Id)">
                        @category.Name
                    </button>
                }
            </div>

            <!-- Products Grid -->
            <div class="products-grid">
                @if (isLoadingProducts)
                {
                    <p style="color: white; padding: 20px;">Cargando...</p>
                }
                else if (filteredProducts.Any())
                {
                    @foreach (var product in filteredProducts)
                    {
                        <button class="product-button" @onclick="() => AddToCart(product)">
                            <div class="product-name">@product.Name</div>
                            <div class="product-price">@product.Price.ToString("F2")</div>
                        </button>
                    }
                }
            </div>
        </div>

        <!-- Right: Ticket (35%) -->
        <div class="order-display-section">
            <div class="order-header-info">
                <span>TICKET #@ticketNumber</span>
                <span>@DateTime.Now.ToString("HH:mm")</span>
            </div>

            <!-- Order Table -->
            <div class="order-table-container">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th class="col-qty">#</th>
                            <th class="col-product">DESC</th>
                            <th class="col-cost">IMP</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in cart)
                        {
                            <tr class="order-row @(selectedCartItem?.ProductId == item.ProductId ? "selected" : "")"
                                @onclick="() => SelectCartItem(item)">
                                <td class="col-qty">@item.Quantity</td>
                                <td class="col-product">
                                    <div class="product-main-name">@item.ProductName</div>
                                    @if (!string.IsNullOrEmpty(item.SpecialInstructions))
                                    {
                                        <div class="product-modifiers">
                                            @foreach (var instruction in item.SpecialInstructions.Split('\n'))
                                            {
                                                <div>> @instruction</div>
                                            }
                                        </div>
                                    }
                                    @if (item.SelectedModifiers.Any())
                                    {
                                        <div class="product-modifiers">
                                            @foreach (var mod in item.SelectedModifiers)
                                            {
                                                <div>+ @mod.Name</div>
                                            }
                                        </div>
                                    }
                                </td>
                                <td class="col-cost">@item.Subtotal.ToString("F2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Item Action Buttons -->
            <div class="item-actions">
                <button class="action-btn" @onclick="() => { if(selectedCartItem != null) IncreaseQuantity(selectedCartItem); }">
                    ‚ûï AGREGAR
                </button>
                <button class="action-btn" @onclick="() => { if(selectedCartItem != null) DecreaseQuantity(selectedCartItem); }">
                    ‚ûñ QUITAR
                </button>
                <button class="action-btn" @onclick="() => { if(selectedCartItem != null) OpenCommentModal(selectedCartItem); }">
                     NOTA
                </button>
                <button class="action-btn btn-delete" @onclick="() => { if(selectedCartItem != null) RemoveFromCart(selectedCartItem); }">
                    üóë BORRAR
                </button>
            </div>

            @if (OrderId.HasValue)
            {
                var added = GetAddedItems().ToList();
                var removed = GetRemovedItems().ToList();
                var modified = GetModifiedItems().ToList();
                if (added.Any() || removed.Any() || modified.Any())
                {
                    <div class="diff-panel">
                        <div class="diff-title">Cambios para esta orden</div>
                        @if (added.Any())
                        {
                            <div class="diff-section add">
                                <div class="diff-label">A√±adidos</div>
                                @foreach (var a in added)
                                {
                                    <div class="diff-row">+ @a.Quantity x @a.ProductName @if(!string.IsNullOrEmpty(a.SpecialInstructions)){<span class="note">(@a.SpecialInstructions)</span>}</div>
                                }
                            </div>
                        }
                        @if (modified.Any())
                        {
                            <div class="diff-section mod">
                                <div class="diff-label">Modificados</div>
                                @foreach (var m in modified)
                                {
                                    <div class="diff-row">~ @m.New.Quantity x @m.New.ProductName
                                        @if(m.Old.Quantity != m.New.Quantity){<span class="note">(antes @m.Old.Quantity)</span>}
                                        @if(m.Old.SpecialInstructions != m.New.SpecialInstructions){
                                            <span class="note">nota: @m.New.SpecialInstructions</span>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        @if (removed.Any())
                        {
                            <div class="diff-section del">
                                <div class="diff-label">Eliminados</div>
                                @foreach (var r in removed)
                                {
                                    <div class="diff-row">- @r.Quantity x @r.ProductName @if(!string.IsNullOrEmpty(r.SpecialInstructions)){<span class="note">(@r.SpecialInstructions)</span>}</div>
                                }
                            </div>
                        }
                    </div>
                }
            }

            <!-- Order Summary -->
            <div class="order-summary-box">
                <div class="summary-line">
                    <span>SUBTOTAL:</span>
                    <span>@CalculateSubtotal().ToString("F2")</span>
                </div>
                <div class="summary-line total-line">
                    <span>TOTAL:</span>
                    <span>@CalculateTotal().ToString("F2")</span>
                </div>
            </div>

            <!-- Final Action Buttons -->
            <div class="final-actions">
                <button class="btn-clear" @onclick="ClearCart">CANCELAR</button>
                <button class="btn-kitchen" @onclick="SendToKitchen" disabled="@isSubmitting">
                    @(OrderId.HasValue ? "üîÑ ACTUALIZAR COCINA" : "COCINA")
                </button>
                <button class="btn-confirm" @onclick="ConfirmOrder" disabled="@isSubmitting">
                    PAGAR
                </button>
            </div>
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" style="margin-top: 15px; background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">
                    @errorMessage
                </div>
            }
            
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success" style="margin-top: 15px; background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">
                    @successMessage
                </div>
            }
        </div>
    </div>
</div>

<style>
    .diff-panel { background:#faf5e6; border:1px dashed #d4a017; border-radius:10px; padding:10px; margin:10px 0; }
    .diff-title { font-weight:800; margin-bottom:6px; color:#8a6d1d; }
    .diff-section { margin-bottom:6px; }
    .diff-label { font-weight:700; font-size:0.9rem; }
    .diff-row { margin-left:8px; font-size:0.9rem; }
    .diff-section.add .diff-label { color:#1e8449; }
    .diff-section.del .diff-label { color:#c0392b; }
    .diff-section.mod .diff-label { color:#2980b9; }
    .diff-row .note { color:#555; margin-left:4px; font-style:italic; }
    .editing-badge { background:#ffeeba; color:#856404; padding:4px 10px; border-radius:8px; font-weight:800; }
    .modifiers-list { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px; }
    .modifier-btn { padding:8px 12px; border:1px solid #ccc; border-radius:5px; background:#fff; cursor:pointer; }
    .modifier-btn.selected { background:#28a745; color:white; border-color:#28a745; }
</style>

<!-- Comment Modal -->
@if (showCommentModal && editingCartItem != null)
{
    <div class="modal-overlay" @onclick="CloseCommentModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Modificar: @editingCartItem.ProductName</h3>
                <button class="modal-close" @onclick="CloseCommentModal">‚úï</button>
            </div>
            <div class="modal-body">
                <p class="modal-hint">Agrega instrucciones especiales (una por l√≠nea):</p>
                
                <!-- Modifiers -->
                <div class="modifiers-list">
                    @foreach (var modifier in availableModifiers.Where(m => m.IsActive))
                    {
                        bool isSelected = tempSelectedModifiers.Any(m => m.Id == modifier.Id);
                        <button class="modifier-btn @(isSelected ? "selected" : "")" 
                                @onclick="() => ToggleModifier(modifier)">
                            @modifier.Name (+‚Ç¨@modifier.Price.ToString("F2"))
                        </button>
                    }
                </div>

                <textarea class="comment-textarea" 
                          @bind="tempComment" 
                          placeholder="Ejemplo:&#10;Sin pepinillos&#10;Extra queso&#10;Bien cocido" 
                          rows="8"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" @onclick="CloseCommentModal">Cancelar</button>
                <button class="btn-modal-save" @onclick="SaveComment">Guardar</button>
            </div>
        </div>
    </div>
}

@* Payment Modal *@
@if (showPaymentModal)
{
    <PaymentModal 
        Subtotal="CalculateSubtotal()"
        Tax="CalculateTax()"
        Total="CalculateTotal()"
        OrderId="pendingOrderId"
        OnClose="ClosePaymentModal"
        OnPaymentConfirmed="HandlePaymentConfirmed" />
}

@code {
    [Parameter] public int CustomerId { get; set; }
    [Parameter] public string OrderTypeStr { get; set; } = "takeout";
    [Parameter] public int PhoneLine { get; set; }
    [Parameter] public int? OrderId { get; set; }
    private int? TableId;

    private Customer? customer;
    private List<Modifier> availableModifiers = new();
    private List<Modifier> tempSelectedModifiers = new();
    private List<Category> categories = new();
    private List<Product> products = new();
    private List<Product> filteredProducts = new();
    private List<CartItem> cart = new();
    private List<CartItem> originalCart = new();
    private int? selectedCategoryId;
    private string orderNotes = "";
    private bool isLoadingProducts = false;
    private bool isSubmitting = false;
    private string errorMessage = "";
    private string successMessage = "";

    // For item selection and modification
    private CartItem? selectedCartItem;
    private CartItem? editingCartItem;
    private bool showCommentModal = false;
    private string tempComment = "";

    private int ticketNumber;

    // Payment modal state
    private bool showPaymentModal = false;
    private int pendingOrderId = 0;
    
    private int? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Parse query string manually (SupplyParameterFromQuery doesn't work with legacy Router)
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var queryParams = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
            if (queryParams.TryGetValue("tableId", out var tableIdVal) && int.TryParse(tableIdVal, out int tid))
                TableId = tid;
            if (!OrderId.HasValue && queryParams.TryGetValue("orderId", out var orderIdVal) && int.TryParse(orderIdVal, out int oid))
                OrderId = oid;

            // Get Current User (Waiter)
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                var idClaim = user.FindFirst("sub") ?? user.FindFirst(ClaimTypes.NameIdentifier);
                if (idClaim != null && int.TryParse(idClaim.Value, out int uid))
                {
                    currentUserId = uid;
                    Logger.LogInformation("Usuario autenticado: {UserId}", currentUserId);
                }
            }

            // Generate ticket number once
            ticketNumber = new Random().Next(1000, 9999);

            Logger.LogInformation("Iniciando OrderCreation para Cliente {CustomerId}, OrderId={OrderId}, TableId={TableId}", CustomerId, OrderId, TableId);
            
            // If TableId is present, force Dine In
            if (TableId.HasValue)
            {
                OrderTypeStr = "dine_in";
            }

            if (CustomerId == 0)
            {
                // ... Existing Walk-In Logic ...
                customer = new Customer
                {
                    Id = 0,
                    Name = "Walk-In",
                    Phone = "",
                    AddressLine1 = "Local"
                };
            }
            else
            {
                // ... Existing Customer Load ...
                 var customerList = await ApiService.GetCustomersAsync();
                customer = customerList.FirstOrDefault(c => c.Id == CustomerId);

                if (customer == null)
                {
                    errorMessage = "Cliente no encontrado";
                    Logger.LogWarning("Cliente {CustomerId} no encontrado", CustomerId);
                    return;
                }
            }

            // Load categories
            categories = await ApiService.GetCategoriesAsync();
            // ...
            
            // Generate ticket number once
            ticketNumber = new Random().Next(1000, 9999);

            // Load all products
            products = await ApiService.GetProductsAsync();

            // Load all available modifiers
            availableModifiers = await ApiService.GetModifiersAsync();

            // Select first category by default
            if (categories.Any())
            {
                selectedCategoryId = categories.First().Id;
                FilterProducts();
            }

            // Si se est√° editando una orden existente, cargarla en el carrito
            if (OrderId.HasValue)
            {
                var existing = await ApiService.GetOrderAsync(OrderId.Value);
                if (existing != null)
                {
                    OrderTypeStr = existing.OrderType;
                    if (existing.TableId.HasValue)
                        TableId = existing.TableId;

                    cart = existing.Items.Select(i => new CartItem
                    {
                        OrderItemId = i.Id,
                        ProductId = i.ProductId,
                        ProductName = i.ProductName ?? $"Producto {i.ProductId}",
                        UnitPrice = i.UnitPrice,
                        Quantity = i.Quantity,
                        SpecialInstructions = i.SpecialInstructions,
                        SelectedModifiers = i.Modifiers.Select(m => new Modifier { Id = m.ModifierId, Name = m.ModifierName, Price = m.AdditionalPrice }).ToList()
                    }).ToList();

                    originalCart = cart.Select(CloneCartItem).ToList();
                }
            }
        }
        catch (Exception ex)
        {
             Logger.LogError(ex, "Error cargando datos");
            errorMessage = $"Error al cargar datos: {ex.Message}";
        }
    }
    
    // ... existing ... 
    
    private string GetOrderTypeLabel()
    {
        if (TableId.HasValue) return $"MESA #{TableId}"; 
        
        return OrderTypeStr.ToLower() switch
        {
            "delivery" => "üöö Delivery",
            "takeout" => "ü•° Para Llevar",
            "dine_in" => "üçΩÔ∏è Comer Aqu√≠",
            _ => OrderTypeStr
        };
    }

    private async Task SendToKitchen()
    {
        if (!cart.Any())
        {
            errorMessage = "El carrito est√° vac√≠o!";
            return;
        }

        if (customer == null)
        {
            errorMessage = "Cliente no encontrado";
            return;
        }

        isSubmitting = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            Logger.LogInformation("Enviando a cocina para {CustomerName}", customer.Name);

            int targetOrderId;

            if (OrderId.HasValue)
            {
                // Actualizar orden existente con diffs
                var update = BuildOrderItemsUpdate();
                var updated = await ApiService.UpdateOrderItemsAsync(OrderId.Value, update);
                if (updated == null)
                {
                    errorMessage = "No se pudo actualizar la orden.";
                    return;
                }
                targetOrderId = updated.Id;
                originalCart = cart.Select(CloneCartItem).ToList();
            }
            else
            {
                var orderData = new OrderCreate
                {
                    CustomerName = customer.Name,
                    OrderType = OrderTypeStr.ToLower(),
                    Items = cart.Select(item => new OrderItemCreate
                    {
                        ProductId = item.ProductId,
                        Quantity = item.Quantity,
                        SpecialInstructions = item.SpecialInstructions,
                        ModifierIds = item.SelectedModifiers.Select(m => m.Id).ToList()
                    }).ToList(),
                    Notes = orderNotes,
                    TableId = TableId,
                    UserId = currentUserId,
                    PaymentMethod = null,
                    Status = "pending"
                };

                var createdOrder = await ApiService.CreateOrderAsync(orderData);
                if (createdOrder == null)
                {
                    errorMessage = "Error al enviar a cocina. Por favor intenta de nuevo.";
                    return;
                }
                targetOrderId = createdOrder.Id;
                OrderId = targetOrderId;
                originalCart = cart.Select(CloneCartItem).ToList();
            }

            Logger.LogInformation("Orden enviada/actualizada: {OrderId}", targetOrderId);
            successMessage = "üç≥ Orden enviada a cocina";
            StateHasChanged();

            await PrintKitchenTicket(targetOrderId);

            // Ticket de cambios para cocina (solo si hay diffs y es edici√≥n)
            if (OrderId.HasValue)
            {
                var added = GetAddedItems().ToList();
                var removed = GetRemovedItems().ToList();
                var modified = GetModifiedItems().ToList();
                if (added.Any() || removed.Any() || modified.Any())
                {
                    await PrintDiffTicket($"Mesa {TableId ?? 0} - Cambios", added, removed, modified);
                }
            }

            await Task.Delay(1200);
            var dest = TableId.HasValue ? $"/tables/{TableId}" : "/tables";
            Navigation.NavigateTo(dest);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al enviar a cocina");
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    // ...

    private async Task ConfirmOrder()
    {
        if (!cart.Any())
        {
            errorMessage = "El carrito est√° vac√≠o!";
            return;
        }

        if (customer == null)
        {
            errorMessage = "Cliente no encontrado";
            return;
        }

        isSubmitting = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            Logger.LogInformation("Confirmando orden para pago: {CustomerName}", customer.Name);

            if (OrderId.HasValue)
            {
                var update = BuildOrderItemsUpdate();
                var updated = await ApiService.UpdateOrderItemsAsync(OrderId.Value, update);
                if (updated == null)
                {
                    errorMessage = "No se pudo actualizar la orden.";
                    return;
                }
                pendingOrderId = updated.Id;
                showPaymentModal = true;
                originalCart = cart.Select(CloneCartItem).ToList();
            }
            else
            {
                var orderData = new OrderCreate
                {
                    CustomerName = customer.Name,
                    OrderType = OrderTypeStr.ToLower(),
                    Items = cart.Select(item => new OrderItemCreate
                    {
                        ProductId = item.ProductId,
                        Quantity = item.Quantity,
                        SpecialInstructions = item.SpecialInstructions,
                        ModifierIds = item.SelectedModifiers.Select(m => m.Id).ToList()
                    }).ToList(),
                    Notes = orderNotes,
                    TableId = TableId,
                    UserId = currentUserId,
                    PaymentMethod = null,
                    Status = "pending"
                };

                var createdOrder = await ApiService.CreateOrderAsync(orderData);

                if (createdOrder != null)
                {
                    pendingOrderId = createdOrder.Id;
                    OrderId = createdOrder.Id;
                    showPaymentModal = true;
                    originalCart = cart.Select(CloneCartItem).ToList();
                }
                else
                {
                    errorMessage = "Error al crear la orden. Por favor intenta de nuevo.";
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al crear orden para pago");
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void ClosePaymentModal()
    {
        showPaymentModal = false;
        pendingOrderId = 0;
        StateHasChanged();
    }

    private async Task HandlePaymentConfirmed(PaymentModal.PaymentResult result)
    {
        try
        {
            Logger.LogInformation("Procesando pago para orden {OrderId}", result.OrderId);

            var payment = new PaymentCreate
            {
                OrderId = result.OrderId,
                PaymentType = result.PaymentType,
                CashAmount = result.CashAmount,
                CardAmount = result.CardAmount,
                TipAmount = result.TipAmount
            };

            var paymentResponse = await ApiService.CreatePaymentAsync(payment);

            if (paymentResponse != null)
            {
                Logger.LogInformation("Pago procesado exitosamente. Cambio: {Change}", paymentResponse.ChangeAmount);
                
                showPaymentModal = false;
                
                // Ticket de cambios (si edici√≥n)
                if (OrderId.HasValue)
                {
                    var added = GetAddedItems().ToList();
                    var removed = GetRemovedItems().ToList();
                    var modified = GetModifiedItems().ToList();
                    if (added.Any() || removed.Any() || modified.Any())
                    {
                        await PrintDiffTicket($"Mesa {TableId ?? 0} - Cambios", added, removed, modified);
                    }
                }
                
                // Mostrar mensaje de √©xito con el cambio si aplica
                if (paymentResponse.ChangeAmount > 0)
                {
                    successMessage = $"‚úì Pago exitoso! Cambio: ‚Ç¨{paymentResponse.ChangeAmount:F2}";
                }
                else
                {
                    successMessage = "‚úì Pago exitoso!";
                }
                
                StateHasChanged();
                
                // Esperar y redirigir al inicio
                await Task.Delay(2500);
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "Error al procesar el pago. Por favor intenta de nuevo.";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error procesando pago");
            errorMessage = $"Error: {ex.Message}";
            StateHasChanged();
        }
    }

    private void CancelOrder()
    {
        if (TableId.HasValue)
            Navigation.NavigateTo($"/tables/{TableId}");
        else
            Navigation.NavigateTo("/");
    }

    private void SelectCategory(int categoryId)
    {
        selectedCategoryId = categoryId;
        FilterProducts();
    }

    private void FilterProducts()
    {
        isLoadingProducts = true;
        filteredProducts = products
            .Where(p => p.CategoryId == selectedCategoryId && p.IsAvailable)
            .ToList();
        isLoadingProducts = false;
        StateHasChanged();
    }

    private void AddToCart(Product product)
    {
        // Busca si ya existe el mismo producto SIN modificadores
        var existingItem = cart.FirstOrDefault(i => 
            i.ProductId == product.Id && 
            string.IsNullOrEmpty(i.SpecialInstructions) && 
            !i.SelectedModifiers.Any());

        if (existingItem != null)
        {
            // Si existe sin modificadores, aumenta la cantidad
            existingItem.Quantity++;
            selectedCartItem = existingItem;
        }
        else
        {
            // Si no existe o tiene modificadores, crea uno nuevo
            var newItem = new CartItem
            {
                ProductId = product.Id,
                ProductName = product.Name,
                UnitPrice = product.Price,
                Quantity = 1
            };
            cart.Add(newItem);
            selectedCartItem = newItem;
        }

        Logger.LogInformation("Item agregado: {ProductName}, Total items en carrito: {Count}", product.Name, cart.Count);
        StateHasChanged();
    }

    private void SelectCartItem(CartItem item)
    {
        selectedCartItem = item;
        StateHasChanged();
    }

    private void IncreaseQuantity(CartItem item)
    {
        item.Quantity++;
        StateHasChanged();
    }

    private void DecreaseQuantity(CartItem item)
    {
        if (item.Quantity > 1)
        {
            item.Quantity--;
        }
        else
        {
            RemoveFromCart(item);
        }
        StateHasChanged();
    }

    private void RemoveFromCart(CartItem item)
    {
        cart.Remove(item);
        if (selectedCartItem == item)
        {
            selectedCartItem = null;
        }
        StateHasChanged();
    }

    private void ClearCart()
    {
        cart.Clear();
        selectedCartItem = null;
        StateHasChanged();
    }

    private void OpenCommentModal(CartItem item)
    {
        editingCartItem = item;
        tempComment = item.SpecialInstructions ?? "";
        tempSelectedModifiers = new List<Modifier>(item.SelectedModifiers);
        showCommentModal = true;
        StateHasChanged();
    }

    private void CloseCommentModal()
    {
        showCommentModal = false;
        editingCartItem = null;
        tempComment = "";
        tempSelectedModifiers.Clear();
        StateHasChanged();
    }

    private void ToggleModifier(Modifier modifier)
    {
        if (tempSelectedModifiers.Any(m => m.Id == modifier.Id))
            tempSelectedModifiers.RemoveAll(m => m.Id == modifier.Id);
        else
            tempSelectedModifiers.Add(modifier);
        StateHasChanged();
    }

    private void SaveComment()
    {
        if (editingCartItem != null)
        {
            editingCartItem.SpecialInstructions = tempComment.Trim();
            editingCartItem.SelectedModifiers = new List<Modifier>(tempSelectedModifiers);
        }
        CloseCommentModal();
    }

    // ===== Helpers para edici√≥n de √≥rdenes existentes =====
    private OrderItemsUpdate BuildOrderItemsUpdate()
    {
        var update = new OrderItemsUpdate();

        // Removidos: estaban antes y ya no est√°n
        var removed = originalCart.Where(o => o.OrderItemId.HasValue && !cart.Any(c => c.OrderItemId == o.OrderItemId)).ToList();
        update.RemoveItemIds.AddRange(removed.Select(r => r.OrderItemId!.Value));

        // Modificados: qty o nota cambi√≥ -> eliminar y reinsertar como nuevo
        var modified = originalCart.Where(o =>
            o.OrderItemId.HasValue &&
            cart.Any(c => {
                if (c.OrderItemId != o.OrderItemId) return false;
                bool modsChanged = string.Join(",", c.SelectedModifiers.Select(sm => sm.Id).OrderBy(id => id)) != 
                                   string.Join(",", o.SelectedModifiers.Select(sm => sm.Id).OrderBy(id => id));
                return c.Quantity != o.Quantity || c.SpecialInstructions != o.SpecialInstructions || modsChanged;
            })
        ).ToList();
        update.RemoveItemIds.AddRange(modified.Select(m => m.OrderItemId!.Value));
        foreach (var m in modified)
        {
            var current = cart.First(c => c.OrderItemId == m.OrderItemId);
            update.AddItems.Add(new OrderItemCreate
            {
                ProductId = current.ProductId,
                Quantity = current.Quantity,
                SpecialInstructions = current.SpecialInstructions,
                ModifierIds = current.SelectedModifiers.Select(sm => sm.Id).ToList()
            });
        }

        // Nuevos: sin OrderItemId
        var added = cart.Where(c => !c.OrderItemId.HasValue).ToList();
        foreach (var a in added)
        {
            update.AddItems.Add(new OrderItemCreate
            {
                ProductId = a.ProductId,
                Quantity = a.Quantity,
                SpecialInstructions = a.SpecialInstructions,
                ModifierIds = a.SelectedModifiers.Select(sm => sm.Id).ToList()
            });
        }

        return update;
    }

    private CartItem CloneCartItem(CartItem c) => new()
    {
        OrderItemId = c.OrderItemId,
        ProductId = c.ProductId,
        ProductName = c.ProductName,
        UnitPrice = c.UnitPrice,
        Quantity = c.Quantity,
        SpecialInstructions = c.SpecialInstructions,
        SelectedModifiers = new List<Modifier>(c.SelectedModifiers)
    };

    private IEnumerable<CartItem> GetAddedItems() =>
        cart.Where(c => !c.OrderItemId.HasValue);

    private IEnumerable<CartItem> GetRemovedItems() =>
        originalCart.Where(o => o.OrderItemId.HasValue && !cart.Any(c => c.OrderItemId == o.OrderItemId));

    private IEnumerable<(CartItem Old, CartItem New)> GetModifiedItems()
    {
        foreach (var oldItem in originalCart.Where(o => o.OrderItemId.HasValue))
        {
            var current = cart.FirstOrDefault(c => c.OrderItemId == oldItem.OrderItemId);
            if (current != null)
            {
                bool modifiersChanged = string.Join(",", current.SelectedModifiers.Select(m => m.Id).OrderBy(id => id)) != 
                                        string.Join(",", oldItem.SelectedModifiers.Select(m => m.Id).OrderBy(id => id));
                if (current.Quantity != oldItem.Quantity || current.SpecialInstructions != oldItem.SpecialInstructions || modifiersChanged)
                {
                    yield return (oldItem, current);
                }
            }
        }
    }

    private decimal CalculateTotal()
    {
        // En modelo Tax Inclusive, el subtotal de cada item YA es el precio final
        return cart.Sum(i => i.Subtotal);
    }

    private decimal CalculateSubtotal()
    {
        // Subtotal = Total / 1.135
        if (CalculateTotal() == 0) return 0;
        return CalculateTotal() / 1.135m;
    }

    private decimal CalculateTax()
    {
        // Tax = Total - Subtotal
        return CalculateTotal() - CalculateSubtotal();
    }

    private async Task PrintKitchenTicket(int orderId)
    {
        try
        {
            var printUrl = $"/print/receipt/{orderId}";
            await JSRuntime.InvokeVoidAsync("window.open", printUrl, "_blank", "width=400,height=600");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "No se pudo abrir ventana de impresi√≥n");
        }
    }

    private async Task PrintDiffTicket(string title, List<CartItem> added, List<CartItem> removed, List<(CartItem Old, CartItem New)> modified)
    {
        var sb = new System.Text.StringBuilder();
        sb.Append("<html><head><style>");
        sb.Append("body{font-family:monospace;padding:12px;} h3{margin:0 0 8px 0;} .sect{margin-bottom:10px;} .add{color:#1e8449;} .del{color:#c0392b;} .mod{color:#2980b9;} .item{margin-left:8px;} .note{color:#555;font-style:italic;}");
        sb.Append("</style></head><body>");
        sb.Append($"<h3>{title}</h3><hr/>");
        if (added.Any())
        {
            sb.Append("<div class='sect add'><strong>A√±adidos</strong><br/>");
            foreach (var a in added)
            {
                sb.Append($"<div class='item'>+ {a.Quantity} x {a.ProductName}");
                if (!string.IsNullOrEmpty(a.SpecialInstructions)) sb.Append($" <span class='note'>({a.SpecialInstructions})</span>");
                sb.Append("</div>");
            }
            sb.Append("</div>");
        }
        if (modified.Any())
        {
            sb.Append("<div class='sect mod'><strong>Modificados</strong><br/>");
            foreach (var m in modified)
            {
                sb.Append($"<div class='item'>~ {m.New.Quantity} x {m.New.ProductName}");
                if (m.Old.Quantity != m.New.Quantity) sb.Append($" <span class='note'>(antes {m.Old.Quantity})</span>");
                if (m.Old.SpecialInstructions != m.New.SpecialInstructions) sb.Append($" <span class='note'>nota: {m.New.SpecialInstructions}</span>");
                sb.Append("</div>");
            }
            sb.Append("</div>");
        }
        if (removed.Any())
        {
            sb.Append("<div class='sect del'><strong>Eliminados</strong><br/>");
            foreach (var r in removed)
            {
                sb.Append($"<div class='item'>- {r.Quantity} x {r.ProductName}");
                if (!string.IsNullOrEmpty(r.SpecialInstructions)) sb.Append($" <span class='note'>({r.SpecialInstructions})</span>");
                sb.Append("</div>");
            }
            sb.Append("</div>");
        }
        sb.Append("<hr/><div style='font-size:11px;color:#666;'>Generado autom√°ticamente</div></body></html>");

        var html = sb.ToString().Replace("`", "\\`");
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", $"var w=window.open('','_blank','width=420,height=640'); w.document.write(`{html}`); w.document.close();");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "No se pudo abrir ticket de cambios");
        }
    }
}
