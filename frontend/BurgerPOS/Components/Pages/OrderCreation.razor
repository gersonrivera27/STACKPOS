@page "/order/create"
@page "/order/{CustomerId:int}/{OrderTypeStr}/{PhoneLine:int}"
@rendermode InteractiveServer
@using BurgerPOS.Models
@using BurgerPOS.Services
@using BurgerPOS.Components.Shared
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject PosApiService ApiService
@inject NavigationManager Navigation
@inject ILogger<OrderCreation> Logger
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider

<div class="order-creation-container">
    <!-- Header -->
    <div class="order-header">
        <div class="brand">
            <div class="brand-icon"></div>
            <span class="brand-name"><strong>STACK</strong> POS</span>
        </div>
        
        <div class="order-info-center">
            <span class="order-title">L√çNEA @PhoneLine - @GetOrderTypeLabel().ToUpper()</span>
            @if (customer != null)
            {
                <span class="customer-name"> | üë§ @customer.Name</span>
            }
        </div>

        <button class="btn-close-order" @onclick="CancelOrder">
            ‚úï SALIR
        </button>
    </div>

    <div class="order-content">
        <!-- Left: Categories & Products (65%) -->
        <div class="products-section">
            <!-- Category Tabs -->
            <div class="category-tabs">
                @foreach (var category in categories)
                {
                    <button class="category-tab @(selectedCategoryId == category.Id ? "active" : "")"
                            @onclick="() => SelectCategory(category.Id)">
                        @category.Name
                    </button>
                }
            </div>

            <!-- Products Grid -->
            <div class="products-grid">
                @if (isLoadingProducts)
                {
                    <p style="color: white; padding: 20px;">Cargando...</p>
                }
                else if (filteredProducts.Any())
                {
                    @foreach (var product in filteredProducts)
                    {
                        <button class="product-button" @onclick="() => AddToCart(product)">
                            <div class="product-name">@product.Name</div>
                            <div class="product-price">@product.Price.ToString("F2")</div>
                        </button>
                    }
                }
            </div>
        </div>

        <!-- Right: Ticket (35%) -->
        <div class="order-display-section">
            <div class="order-header-info">
                <span>TICKET #@ticketNumber</span>
                <span>@DateTime.Now.ToString("HH:mm")</span>
            </div>

            <!-- Order Table -->
            <div class="order-table-container">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th class="col-qty">#</th>
                            <th class="col-product">DESC</th>
                            <th class="col-cost">IMP</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in cart)
                        {
                            <tr class="order-row @(selectedCartItem?.ProductId == item.ProductId ? "selected" : "")"
                                @onclick="() => SelectCartItem(item)">
                                <td class="col-qty">@item.Quantity</td>
                                <td class="col-product">
                                    <div class="product-main-name">@item.ProductName</div>
                                    @if (!string.IsNullOrEmpty(item.SpecialInstructions))
                                    {
                                        <div class="product-modifiers">
                                            @foreach (var instruction in item.SpecialInstructions.Split('\n'))
                                            {
                                                <div>> @instruction</div>
                                            }
                                        </div>
                                    }
                                </td>
                                <td class="col-cost">@item.Subtotal.ToString("F2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Item Action Buttons -->
            <div class="item-actions">
                <button class="action-btn" @onclick="() => { if(selectedCartItem != null) IncreaseQuantity(selectedCartItem); }">
                    ‚ûï AGREGAR
                </button>
                <button class="action-btn" @onclick="() => { if(selectedCartItem != null) DecreaseQuantity(selectedCartItem); }">
                    ‚ûñ QUITAR
                </button>
                <button class="action-btn" @onclick="() => { if(selectedCartItem != null) OpenCommentModal(selectedCartItem); }">
                     NOTA
                </button>
                <button class="action-btn btn-delete" @onclick="() => { if(selectedCartItem != null) RemoveFromCart(selectedCartItem); }">
                    üóë BORRAR
                </button>
            </div>

            <!-- Order Summary -->
            <div class="order-summary-box">
                <div class="summary-line">
                    <span>SUBTOTAL:</span>
                    <span>@CalculateSubtotal().ToString("F2")</span>
                </div>
                <div class="summary-line total-line">
                    <span>TOTAL:</span>
                    <span>@CalculateTotal().ToString("F2")</span>
                </div>
            </div>

            <!-- Final Action Buttons -->
            <div class="final-actions">
                <button class="btn-clear" @onclick="ClearCart">CANCELAR</button>
                <button class="btn-kitchen" @onclick="SendToKitchen" disabled="@isSubmitting">
                    COCINA
                </button>
                <button class="btn-confirm" @onclick="ConfirmOrder" disabled="@isSubmitting">
                    PAGAR
                </button>
            </div>
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" style="margin-top: 15px; background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">
                    @errorMessage
                </div>
            }
            
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success" style="margin-top: 15px; background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px;">
                    @successMessage
                </div>
            }
        </div>
    </div>
</div>

<!-- Comment Modal -->
@if (showCommentModal && editingCartItem != null)
{
    <div class="modal-overlay" @onclick="CloseCommentModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Modificar: @editingCartItem.ProductName</h3>
                <button class="modal-close" @onclick="CloseCommentModal">‚úï</button>
            </div>
            <div class="modal-body">
                <p class="modal-hint">Agrega instrucciones especiales (una por l√≠nea):</p>
                
                <!-- Quick Modifiers -->
                <div class="quick-modifiers">
                    <button class="quick-mod-btn" @onclick='() => AddQuickModifier("Sin pepinillos")'>Sin pepinillos</button>
                    <button class="quick-mod-btn" @onclick='() => AddQuickModifier("Sin queso")'>Sin queso</button>
                    <button class="quick-mod-btn" @onclick='() => AddQuickModifier("Sin cebolla")'>Sin cebolla</button>
                    <button class="quick-mod-btn" @onclick='() => AddQuickModifier("Sin tomate")'>Sin tomate</button>
                    <button class="quick-mod-btn" @onclick='() => AddQuickModifier("Bien cocido")'>Bien cocido</button>
                    <button class="quick-mod-btn" @onclick='() => AddQuickModifier("T√©rmino medio")'>T√©rmino medio</button>
                    <button class="quick-mod-btn" @onclick='() => AddQuickModifier("Extra queso")'>Extra queso</button>
                    <button class="quick-mod-btn" @onclick='() => AddQuickModifier("Extra bacon")'>Extra bacon</button>
                </div>

                <textarea class="comment-textarea" 
                          @bind="tempComment" 
                          placeholder="Ejemplo:&#10;Sin pepinillos&#10;Extra queso&#10;Bien cocido" 
                          rows="8"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" @onclick="CloseCommentModal">Cancelar</button>
                <button class="btn-modal-save" @onclick="SaveComment">Guardar</button>
            </div>
        </div>
    </div>
}

@* Payment Modal *@
@if (showPaymentModal)
{
    <PaymentModal 
        Subtotal="CalculateSubtotal()"
        Tax="CalculateTax()"
        Total="CalculateTotal()"
        OrderId="pendingOrderId"
        OnClose="ClosePaymentModal"
        OnPaymentConfirmed="HandlePaymentConfirmed" />
}

@code {
    [Parameter] public int CustomerId { get; set; }
    [Parameter] public string OrderTypeStr { get; set; } = "takeout";
    [Parameter] public int PhoneLine { get; set; }
    [SupplyParameterFromQuery] public int? TableId { get; set; }

    private Customer? customer;
    private List<Category> categories = new();
    private List<Product> products = new();
    private List<Product> filteredProducts = new();
    private List<CartItem> cart = new();
    private int? selectedCategoryId;
    private string orderNotes = "";
    private bool isLoadingProducts = false;
    private bool isSubmitting = false;
    private string errorMessage = "";
    private string successMessage = "";

    // For item selection and modification
    private CartItem? selectedCartItem;
    private CartItem? editingCartItem;
    private bool showCommentModal = false;
    private string tempComment = "";

    private int ticketNumber;

    // Payment modal state
    private bool showPaymentModal = false;
    private int pendingOrderId = 0;
    
    private int? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get Current User (Waiter)
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                var idClaim = user.FindFirst("sub") ?? user.FindFirst(ClaimTypes.NameIdentifier);
                if (idClaim != null && int.TryParse(idClaim.Value, out int uid))
                {
                    currentUserId = uid;
                    Logger.LogInformation("Usuario autenticado: {UserId}", currentUserId);
                }
            }

            // Generate ticket number once
            ticketNumber = new Random().Next(1000, 9999);

            Logger.LogInformation("Iniciando OrderCreation para Cliente {CustomerId}", CustomerId);
            
            // If TableId is present, force Dine In
            if (TableId.HasValue)
            {
                OrderTypeStr = "dine_in";
            }

            if (CustomerId == 0)
            {
                // ... Existing Walk-In Logic ...
                customer = new Customer
                {
                    Id = 0,
                    Name = "Walk-In",
                    Phone = "",
                    AddressLine1 = "Local"
                };
            }
            else
            {
                // ... Existing Customer Load ...
                 var customerList = await ApiService.GetCustomersAsync();
                customer = customerList.FirstOrDefault(c => c.Id == CustomerId);

                if (customer == null)
                {
                    errorMessage = "Cliente no encontrado";
                    Logger.LogWarning("Cliente {CustomerId} no encontrado", CustomerId);
                    return;
                }
            }

            // Load categories
            categories = await ApiService.GetCategoriesAsync();
            // ...
            
            // Generate ticket number once
            ticketNumber = new Random().Next(1000, 9999);

            // Load all products
            products = await ApiService.GetProductsAsync();

            // Select first category by default
            if (categories.Any())
            {
                selectedCategoryId = categories.First().Id;
                FilterProducts();
            }
        }
        catch (Exception ex)
        {
             Logger.LogError(ex, "Error cargando datos");
            errorMessage = $"Error al cargar datos: {ex.Message}";
        }
    }
    
    // ... existing ... 
    
    private string GetOrderTypeLabel()
    {
        if (TableId.HasValue) return $"MESA #{TableId}"; 
        
        return OrderTypeStr.ToLower() switch
        {
            "delivery" => "üöö Delivery",
            "takeout" => "ü•° Para Llevar",
            "dine_in" => "üçΩÔ∏è Comer Aqu√≠",
            _ => OrderTypeStr
        };
    }

    private async Task SendToKitchen()
    {
        if (!cart.Any())
        {
            errorMessage = "El carrito est√° vac√≠o!";
            return;
        }

        if (customer == null)
        {
            errorMessage = "Cliente no encontrado";
            return;
        }

        isSubmitting = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            Logger.LogInformation("Enviando a cocina para {CustomerName}", customer.Name);

            var orderData = new OrderCreate
            {
                CustomerName = customer.Name,
                OrderType = OrderTypeStr.ToLower(),
                Items = cart.Select(item => new OrderItemCreate
                {
                    ProductId = item.ProductId,
                    Quantity = item.Quantity,
                    SpecialInstructions = item.SpecialInstructions
                }).ToList(),
                Notes = orderNotes,
                TableId = TableId,
                UserId = currentUserId,
                PaymentMethod = null,
                Status = "pending"
            };

            var createdOrder = await ApiService.CreateOrderAsync(orderData);

            if (createdOrder != null)
            {
                Logger.LogInformation("Orden enviada a cocina: {OrderNumber}", createdOrder.OrderNumber);
                successMessage = $"üç≥ Orden {createdOrder.OrderNumber} enviada a cocina!";
                StateHasChanged();
                
                await PrintKitchenTicket(createdOrder.Id);
                
                await Task.Delay(1500);
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "Error al enviar a cocina. Por favor intenta de nuevo.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al enviar a cocina");
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    // ...

    private async Task ConfirmOrder()
    {
        if (!cart.Any())
        {
            errorMessage = "El carrito est√° vac√≠o!";
            return;
        }

        if (customer == null)
        {
            errorMessage = "Cliente no encontrado";
            return;
        }

        isSubmitting = true;
        errorMessage = "";
        successMessage = "";

        try
        {
            Logger.LogInformation("Creando orden para pago: {CustomerName}", customer.Name);

            // Primero crear la orden con estado "pending"
            var orderData = new OrderCreate
            {
                CustomerName = customer.Name,
                OrderType = OrderTypeStr.ToLower(),
                Items = cart.Select(item => new OrderItemCreate
                {
                    ProductId = item.ProductId,
                    Quantity = item.Quantity,
                    SpecialInstructions = item.SpecialInstructions
                }).ToList(),
                Notes = orderNotes,
                TableId = TableId,
                UserId = currentUserId,
                PaymentMethod = null,
                Status = "pending"
            };

            var createdOrder = await ApiService.CreateOrderAsync(orderData);

            if (createdOrder != null)
            {
                Logger.LogInformation("Orden creada: {OrderNumber}, abriendo modal de pago", createdOrder.OrderNumber);
                pendingOrderId = createdOrder.Id;
                showPaymentModal = true;
            }
            else
            {
                errorMessage = "Error al crear la orden. Por favor intenta de nuevo.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al crear orden para pago");
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private void ClosePaymentModal()
    {
        showPaymentModal = false;
        pendingOrderId = 0;
        StateHasChanged();
    }

    private async Task HandlePaymentConfirmed(PaymentModal.PaymentResult result)
    {
        try
        {
            Logger.LogInformation("Procesando pago para orden {OrderId}", result.OrderId);

            var payment = new PaymentCreate
            {
                OrderId = result.OrderId,
                PaymentType = result.PaymentType,
                CashAmount = result.CashAmount,
                CardAmount = result.CardAmount,
                TipAmount = result.TipAmount
            };

            var paymentResponse = await ApiService.CreatePaymentAsync(payment);

            if (paymentResponse != null)
            {
                Logger.LogInformation("Pago procesado exitosamente. Cambio: {Change}", paymentResponse.ChangeAmount);
                
                showPaymentModal = false;
                
                // Mostrar mensaje de √©xito con el cambio si aplica
                if (paymentResponse.ChangeAmount > 0)
                {
                    successMessage = $"‚úì Pago exitoso! Cambio: ‚Ç¨{paymentResponse.ChangeAmount:F2}";
                }
                else
                {
                    successMessage = "‚úì Pago exitoso!";
                }
                
                StateHasChanged();
                
                // Esperar y redirigir al inicio
                await Task.Delay(2500);
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = "Error al procesar el pago. Por favor intenta de nuevo.";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error procesando pago");
            errorMessage = $"Error: {ex.Message}";
            StateHasChanged();
        }
    }

    private void CancelOrder()
    {
        Navigation.NavigateTo("/");
    }

    private void SelectCategory(int categoryId)
    {
        selectedCategoryId = categoryId;
        FilterProducts();
    }

    private void FilterProducts()
    {
        isLoadingProducts = true;
        filteredProducts = products
            .Where(p => p.CategoryId == selectedCategoryId && p.IsAvailable)
            .ToList();
        isLoadingProducts = false;
        StateHasChanged();
    }

    private void AddToCart(Product product)
    {
        // Busca si ya existe el mismo producto SIN modificadores
        var existingItem = cart.FirstOrDefault(i => 
            i.ProductId == product.Id && 
            string.IsNullOrEmpty(i.SpecialInstructions));

        if (existingItem != null)
        {
            // Si existe sin modificadores, aumenta la cantidad
            existingItem.Quantity++;
            selectedCartItem = existingItem;
        }
        else
        {
            // Si no existe o tiene modificadores, crea uno nuevo
            var newItem = new CartItem
            {
                ProductId = product.Id,
                ProductName = product.Name,
                UnitPrice = product.Price,
                Quantity = 1
            };
            cart.Add(newItem);
            selectedCartItem = newItem;
        }

        Logger.LogInformation("Item agregado: {ProductName}, Total items en carrito: {Count}", product.Name, cart.Count);
        StateHasChanged();
    }

    private void SelectCartItem(CartItem item)
    {
        selectedCartItem = item;
        StateHasChanged();
    }

    private void IncreaseQuantity(CartItem item)
    {
        item.Quantity++;
        StateHasChanged();
    }

    private void DecreaseQuantity(CartItem item)
    {
        if (item.Quantity > 1)
        {
            item.Quantity--;
        }
        else
        {
            RemoveFromCart(item);
        }
        StateHasChanged();
    }

    private void RemoveFromCart(CartItem item)
    {
        cart.Remove(item);
        if (selectedCartItem == item)
        {
            selectedCartItem = null;
        }
        StateHasChanged();
    }

    private void ClearCart()
    {
        cart.Clear();
        selectedCartItem = null;
        StateHasChanged();
    }

    private void OpenCommentModal(CartItem item)
    {
        editingCartItem = item;
        tempComment = item.SpecialInstructions ?? "";
        showCommentModal = true;
        StateHasChanged();
    }

    private void CloseCommentModal()
    {
        showCommentModal = false;
        editingCartItem = null;
        tempComment = "";
        StateHasChanged();
    }

    private void AddQuickModifier(string modifier)
    {
        if (!string.IsNullOrEmpty(tempComment) && !tempComment.EndsWith("\n"))
        {
            tempComment += "\n";
        }
        tempComment += modifier;
        StateHasChanged();
    }

    private void SaveComment()
    {
        if (editingCartItem != null)
        {
            editingCartItem.SpecialInstructions = tempComment.Trim();
        }
        CloseCommentModal();
    }

    private decimal CalculateTotal()
    {
        // En modelo Tax Inclusive, el subtotal de cada item YA es el precio final
        return cart.Sum(i => i.Subtotal);
    }

    private decimal CalculateSubtotal()
    {
        // Subtotal = Total / 1.135
        if (CalculateTotal() == 0) return 0;
        return CalculateTotal() / 1.135m;
    }

    private decimal CalculateTax()
    {
        // Tax = Total - Subtotal
        return CalculateTotal() - CalculateSubtotal();
    }

    private async Task PrintKitchenTicket(int orderId)
    {
        try
        {
            var printUrl = $"/print/receipt/{orderId}";
            await JSRuntime.InvokeVoidAsync("window.open", printUrl, "_blank", "width=400,height=600");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "No se pudo abrir ventana de impresi√≥n");
        }
    }
}
